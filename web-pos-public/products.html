<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Produk - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">ü§ñ GiHa Smart Bot</div>
        <div class="nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/products" class="active">Produk</a>
            <a href="/admin">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Produk Tersedia</h1>
            <div class="user-balance">
                Saldo: <strong id="userBalance">Rp 0</strong>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Cari produk..." onkeyup="filterProducts()">
        </div>

        <div id="productGrid" class="product-grid">
            <div class="loading-state">Memuat produk...</div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePurchaseModal()">&times;</span>
            <h2>Konfirmasi Pembelian</h2>
            
            <div class="product-detail">
                <h3 id="modalProductName"></h3>
                <p id="modalProductDesc"></p>
            </div>

            <div class="form-group">
                <label for="quantity">Jumlah</label>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()">
            </div>

            <div class="purchase-summary">
                <div class="summary-row">
                    <span>Harga per item:</span>
                    <span id="pricePerItem">Rp 0</span>
                </div>
                <div class="summary-row">
                    <span>Jumlah:</span>
                    <span id="summaryQty">1</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="totalPrice">Rp 0</span>
                </div>
            </div>

            <div id="modalAlert" class="alert"></div>

            <button class="btn-primary" id="btnPurchase" onclick="confirmPurchase()">
                Beli Sekarang
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSuccessModal()">&times;</span>
            <div class="success-icon">‚úÖ</div>
            <h2>Pembelian Berhasil!</h2>
            
            <div class="purchase-info">
                <p><strong>Refid:</strong> <span id="successRefId"></span></p>
                <p><strong>Saldo Baru:</strong> <span id="successBalance"></span></p>
            </div>

            <div id="accountDetails" class="account-details"></div>

            <div class="modal-actions">
                <button class="btn-copy" onclick="copyPurchaseReceipt()">
                    üìã Copy Receipt
                </button>
                <button class="btn-secondary" onclick="closeSuccessModal()">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let allProducts = [];
        let selectedProduct = null;
        let currentUserData = null;
        let currentReceiptText = null;
        let currentRefId = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    window.location.href = '/';
                    return;
                }

                currentUserData = data.user;
                document.getElementById('userBalance').textContent = formatRupiah(data.user.saldo);

                // Show Admin tab if user is admin
                if (data.user.isAdmin) {
                    const adminLink = document.querySelector('a[href="/admin"]');
                    if (adminLink) adminLink.classList.add('show-admin');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                if (!data.success) {
                    document.getElementById('productGrid').innerHTML = 
                        '<p class="empty-state">Gagal memuat produk</p>';
                    return;
                }

                allProducts = data.products;
                displayProducts(allProducts);
            } catch (error) {
                console.error('Load products failed:', error);
                document.getElementById('productGrid').innerHTML = 
                    '<p class="empty-state">Terjadi kesalahan saat memuat produk</p>';
            }
        }

        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');

            if (products.length === 0) {
                productGrid.innerHTML = '<p class="empty-state">Tidak ada produk tersedia</p>';
                return;
            }

            productGrid.innerHTML = products.map(product => `
                <div class="product-card" onclick="openPurchaseModal('${product.id}')">
                    <div class="product-header">
                        <h3>${product.name}</h3>
                        <span class="product-stock">Stok: ${product.stock}</span>
                    </div>
                    <p class="product-description">${product.description || 'Tidak ada deskripsi'}</p>
                    <div class="product-footer">
                        <div class="product-price">${formatRupiah(product.price)}</div>
                        <button class="btn-buy" onclick="event.stopPropagation(); openPurchaseModal('${product.id}')">
                            Beli
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                (p.description && p.description.toLowerCase().includes(searchTerm))
            );
            displayProducts(filtered);
        }

        function openPurchaseModal(productId) {
            selectedProduct = allProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            // Reset modal state
            const btnPurchase = document.getElementById('btnPurchase');
            btnPurchase.disabled = false;
            btnPurchase.textContent = 'Beli Sekarang';
            
            // Clear any previous alerts
            const alertBox = document.getElementById('modalAlert');
            alertBox.className = 'alert';
            alertBox.textContent = '';

            document.getElementById('modalProductName').textContent = selectedProduct.name;
            document.getElementById('modalProductDesc').textContent = 
                selectedProduct.description || 'Tidak ada deskripsi';
            document.getElementById('pricePerItem').textContent = formatRupiah(selectedProduct.price);
            document.getElementById('quantity').value = 1;
            document.getElementById('quantity').max = selectedProduct.stock;
            
            updateTotalPrice();
            
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'none';
            selectedProduct = null;
        }

        function updateTotalPrice() {
            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const total = selectedProduct.price * quantity;

            document.getElementById('summaryQty').textContent = quantity;
            document.getElementById('totalPrice').textContent = formatRupiah(total);
        }

        function showModalAlert(message, type = 'error') {
            const alertBox = document.getElementById('modalAlert');
            alertBox.textContent = message;
            alertBox.className = `alert ${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        async function confirmPurchase() {
            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;

            if (quantity < 1) {
                showModalAlert('Jumlah minimal 1');
                return;
            }

            if (quantity > selectedProduct.stock) {
                showModalAlert('Jumlah melebihi stok tersedia');
                return;
            }

            const btnPurchase = document.getElementById('btnPurchase');
            btnPurchase.disabled = true;
            btnPurchase.innerHTML = '<span class="loading"></span>Memproses...';

            try {
                const response = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: selectedProduct.id,
                        quantity: quantity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Reset button state first
                    btnPurchase.disabled = false;
                    btnPurchase.textContent = 'Beli Sekarang';
                    
                    closePurchaseModal();
                    showSuccessModal(data.transaction);
                    
                    // Reload products and balance
                    await loadProducts();
                    await checkAuth();
                } else {
                    showModalAlert(data.message || 'Pembelian gagal');
                    btnPurchase.disabled = false;
                    btnPurchase.textContent = 'Beli Sekarang';
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showModalAlert('Terjadi kesalahan saat memproses pembelian');
                btnPurchase.disabled = false;
                btnPurchase.textContent = 'Beli Sekarang';
            }
        }

        function showSuccessModal(transaction) {
            document.getElementById('successRefId').textContent = transaction.refId;
            document.getElementById('successBalance').textContent = formatRupiah(transaction.newBalance);
            
            // Store receipt content globally
            currentReceiptText = transaction.receiptContent || null;
            currentRefId = transaction.refId;

            // Build detail text similar to WhatsApp bot format
            let detailHTML = '<div class="purchase-details">';
            detailHTML += `<h3>üì¶ ${transaction.productName}</h3>`;
            detailHTML += `<div class="purchase-meta">`;
            detailHTML += `<p><strong>üìÖ Tanggal:</strong> ${transaction.date}</p>`;
            detailHTML += `<p><strong>‚è∞ Jam:</strong> ${transaction.time} WIB</p>`;
            detailHTML += `<p><strong>Refid:</strong> ${transaction.refId}</p>`;
            detailHTML += `</div>`;
            detailHTML += '<h3 style="margin-top: 20px;">Detail Akun:</h3>';
            
            transaction.items.forEach((item) => {
                detailHTML += `
                    <div class="account-item">
                        <h4>Akun ${item.index}</h4>
                        <p><span class="label">üìß Email:</span> ${item.email}</p>
                        <p><span class="label">üîê Password:</span> ${item.password}</p>
                        <p><span class="label">üë§ Profil:</span> ${item.profile}</p>
                        <p><span class="label">üî¢ Pin:</span> ${item.pin}</p>
                        <p><span class="label">üîí 2FA:</span> ${item.twofa}</p>
                    </div>
                `;
            });
            
            // Add SNK if exists
            if (transaction.snk) {
                detailHTML += `
                    <div class="snk-section">
                        <h3>‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ„Äå SYARAT & KETENTUAN „Äç‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ</h3>
                        <h4>üìã SNK PRODUK: ${transaction.productName}</h4>
                        <div class="snk-content">${transaction.snk.replace(/\n/g, '<br>')}</div>
                        <h3>‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ„Äå END SNK „Äç‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ</h3>
                    </div>
                `;
            }
            
            detailHTML += '</div>';

            document.getElementById('accountDetails').innerHTML = detailHTML;
            document.getElementById('successModal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            currentReceiptText = null;
            currentRefId = null;
        }

        async function copyPurchaseReceipt() {
            try {
                if (!currentReceiptText) {
                    showToast('Receipt tidak tersedia', 'error');
                    return;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(currentReceiptText);
                showToast('‚úÖ Receipt berhasil dicopy!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                
                // Fallback method for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentReceiptText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('‚úÖ Receipt berhasil dicopy!', 'success');
                } catch (fallbackError) {
                    showToast('‚ùå Gagal copy receipt', 'error');
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const purchaseModal = document.getElementById('purchaseModal');
            const successModal = document.getElementById('successModal');
            if (event.target === purchaseModal) {
                closePurchaseModal();
            }
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }

        // Initialize
        checkAuth();
        loadProducts();
    </script>
</body>
</html>

