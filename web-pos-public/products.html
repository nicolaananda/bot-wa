<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Produk - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">ü§ñ GiHa Smart Bot</div>
        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle menu">
            <span id="menuIcon">‚ò∞</span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard">Dashboard</a>
            <a href="/products" class="active">Produk</a>
            <a href="/admin">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Products Hero Header -->
        <div class="products-hero">
            <div class="products-hero-content">
                <div class="hero-badge">üõçÔ∏è Shop</div>
                <h1 class="products-hero-title">Produk Digital</h1>
                <p class="products-hero-subtitle">Pilih produk terbaik untuk kebutuhan Anda</p>
            </div>
            <div class="balance-widget">
                <div class="balance-widget-icon">üí∞</div>
                <div class="balance-widget-content">
                    <span class="balance-widget-label">Saldo Anda</span>
                    <strong class="balance-widget-value" id="userBalance">Rp 0</strong>
                </div>
            </div>
        </div>

        <!-- Modern Search Bar -->
        <div class="search-container-modern">
            <div class="search-icon">üîç</div>
            <input type="text" id="searchInput" class="search-input-modern" placeholder="Cari produk yang Anda butuhkan..." onkeyup="filterProducts()">
            <div class="search-animation"></div>
        </div>

        <!-- Products Grid with New Design -->
        <div id="productGrid" class="product-grid-modern">
            <div class="loading-state-modern">
                <div class="loader-spinner"></div>
                <p>Memuat produk...</p>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePurchaseModal()">&times;</span>
            <h2>Konfirmasi Pembelian</h2>
            
            <div class="product-detail">
                <h3 id="modalProductName"></h3>
                <p id="modalProductDesc"></p>
            </div>

            <div class="form-group">
                <label for="quantity">Jumlah</label>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()">
            </div>

            <div class="purchase-summary">
                <div class="summary-row">
                    <span>Harga per item:</span>
                    <span id="pricePerItem">Rp 0</span>
                </div>
                <div class="summary-row">
                    <span>Jumlah:</span>
                    <span id="summaryQty">1</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="totalPrice">Rp 0</span>
                </div>
            </div>

            <div id="modalAlert" class="alert"></div>

            <button class="btn-primary" id="btnPurchase" onclick="confirmPurchase()">
                Beli Sekarang
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content transaction-modal-content">
            <div class="modal-header">
                <h2>Pembelian Berhasil!</h2>
                <div class="modal-header-actions">
                    <button class="btn-copy btn-copy-header" onclick="copyPurchaseReceipt()">
                        üìã Copy Receipt
                    </button>
                    <span class="modal-close" onclick="closeSuccessModal()">&times;</span>
                </div>
            </div>
            
            <div class="modal-body">
                <div id="transactionDetail" class="transaction-detail"></div>
                <div id="accountDetailsSection" class="account-details-section"></div>
                <div id="snkSection" class="snk-section"></div>
            </div>
            
            <div class="modal-actions-bottom">
                <button class="btn-secondary" onclick="closeSuccessModal()">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let allProducts = [];
        let selectedProduct = null;
        let currentUserData = null;
        let currentReceiptText = null;
        let currentRefId = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    // Guest mode - show login button instead of balance
                    currentUserData = null;
                    const balanceElement = document.getElementById('userBalance');
                    if (balanceElement) {
                        balanceElement.parentElement.innerHTML = `
                            <a href="/" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.5rem 1rem;">
                                üîê Login
                            </a>
                        `;
                    }
                    return;
                }

                currentUserData = data.user;
                document.getElementById('userBalance').textContent = formatRupiah(data.user.saldo);

                // Show Admin tab if user is admin
                if (data.user.isAdmin) {
                    const adminLink = document.querySelector('a[href="/admin"]');
                    if (adminLink) adminLink.classList.add('show-admin');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Guest mode - don't redirect, just show login button
                currentUserData = null;
                const balanceElement = document.getElementById('userBalance');
                if (balanceElement) {
                    balanceElement.parentElement.innerHTML = `
                        <a href="/" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.5rem 1rem;">
                            üîê Login
                        </a>
                    `;
                }
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                if (!data.success) {
                    document.getElementById('productGrid').innerHTML = 
                        '<p class="empty-state">Gagal memuat produk</p>';
                    return;
                }

                allProducts = data.products;
                displayProducts(allProducts);
            } catch (error) {
                console.error('Load products failed:', error);
                document.getElementById('productGrid').innerHTML = 
                    '<p class="empty-state">Terjadi kesalahan saat memuat produk</p>';
            }
        }

        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');

            if (products.length === 0) {
                productGrid.innerHTML = `
                    <div class="empty-state-modern">
                        <div class="empty-icon">üì¶</div>
                        <h3>Tidak ada produk</h3>
                        <p>Produk akan tersedia segera</p>
                    </div>`;
                return;
            }

            productGrid.innerHTML = products.map((product, index) => `
                <div class="product-card-new" style="animation-delay: ${index * 0.1}s" onclick="openPurchaseModal('${product.id}')">
                    <div class="product-card-shine"></div>
                    <div class="product-image-placeholder">
                        <span class="product-emoji">üì¶</span>
                        ${product.stock > 0 ? 
                            `<div class="stock-badge available">‚úì Tersedia</div>` : 
                            `<div class="stock-badge unavailable">‚úï Habis</div>`
                        }
                    </div>
                    <div class="product-content-new">
                        <div class="product-category-badge">Digital</div>
                        <h3 class="product-title-new">${product.name}</h3>
                        <p class="product-desc-new">${product.description || 'Produk digital berkualitas'}</p>
                        <div class="product-meta-new">
                            <div class="product-stock-info">
                                <span class="stock-icon">üìä</span>
                                <span>${product.stock} stok</span>
                            </div>
                        </div>
                    </div>
                    <div class="product-footer-new">
                        <div class="product-price-new">
                            <span class="price-label">Harga</span>
                            <span class="price-value">${formatRupiah(product.price)}</span>
                        </div>
                        <button class="btn-buy-new" onclick="event.stopPropagation(); openPurchaseModal('${product.id}')" ${product.stock === 0 ? 'disabled' : ''}>
                            <span class="btn-icon">üõí</span>
                            <span>Beli Sekarang</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                (p.description && p.description.toLowerCase().includes(searchTerm))
            );
            displayProducts(filtered);
        }

        function openPurchaseModal(productId) {
            selectedProduct = allProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            // Check if user is logged in
            if (!currentUserData) {
                // Guest mode - redirect to login
                if (confirm('Anda harus login terlebih dahulu untuk melakukan pembelian. Ingin login sekarang?')) {
                    window.location.href = '/';
                }
                return;
            }

            // Reset modal state
            const btnPurchase = document.getElementById('btnPurchase');
            btnPurchase.disabled = false;
            btnPurchase.textContent = 'Beli Sekarang';
            
            // Clear any previous alerts
            const alertBox = document.getElementById('modalAlert');
            alertBox.className = 'alert';
            alertBox.textContent = '';

            document.getElementById('modalProductName').textContent = selectedProduct.name;
            document.getElementById('modalProductDesc').textContent = 
                selectedProduct.description || 'Tidak ada deskripsi';
            document.getElementById('pricePerItem').textContent = formatRupiah(selectedProduct.price);
            document.getElementById('quantity').value = 1;
            document.getElementById('quantity').max = selectedProduct.stock;
            
            updateTotalPrice();
            
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'none';
            selectedProduct = null;
        }

        function updateTotalPrice() {
            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const total = selectedProduct.price * quantity;

            document.getElementById('summaryQty').textContent = quantity;
            document.getElementById('totalPrice').textContent = formatRupiah(total);
        }

        function showModalAlert(message, type = 'error') {
            const alertBox = document.getElementById('modalAlert');
            alertBox.textContent = message;
            alertBox.className = `alert ${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        async function confirmPurchase() {
            // Check if user is logged in
            if (!currentUserData) {
                showModalAlert('Anda harus login terlebih dahulu untuk melakukan pembelian');
                if (confirm('Ingin login sekarang?')) {
                    window.location.href = '/';
                }
                return;
            }

            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;

            if (quantity < 1) {
                showModalAlert('Jumlah minimal 1');
                return;
            }

            if (quantity > selectedProduct.stock) {
                showModalAlert('Jumlah melebihi stok tersedia');
                return;
            }

            const btnPurchase = document.getElementById('btnPurchase');
            btnPurchase.disabled = true;
            btnPurchase.innerHTML = '<span class="loading"></span>Memproses...';

            try {
                const response = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: selectedProduct.id,
                        quantity: quantity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Reset button state first
                    btnPurchase.disabled = false;
                    btnPurchase.textContent = 'Beli Sekarang';
                    
                    closePurchaseModal();
                    showSuccessModal(data.transaction);
                    
                    // Reload products and balance
                    await loadProducts();
                    await checkAuth();
                } else {
                    showModalAlert(data.message || 'Pembelian gagal');
                    btnPurchase.disabled = false;
                    btnPurchase.textContent = 'Beli Sekarang';
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showModalAlert('Terjadi kesalahan saat memproses pembelian');
                btnPurchase.disabled = false;
                btnPurchase.textContent = 'Beli Sekarang';
            }
        }

        function showSuccessModal(transaction) {
            // Store receipt content globally
            currentReceiptText = transaction.receiptContent || null;
            currentRefId = transaction.refId;

            // Parse tanggal dan jam
            const dateTime = transaction.date ? transaction.date.split(' ') : ['', ''];
            const tanggal = dateTime[0] || 'N/A';
            const jam = dateTime[1] || transaction.time || 'N/A';

            // Build account info header (same format as transaction detail)
            let detailHTML = '<div class="account-info-header">';
            detailHTML += `<h3>Account Information</h3>`;
            detailHTML += `<div class="info-item">üì¶ <strong>Produk:‚òÖ</strong> ${transaction.productName}</div>`;
            detailHTML += `<div class="info-item">üìÖ <strong>Tanggal:‚òÖ</strong> ${tanggal}</div>`;
            detailHTML += `<div class="info-item">‚è±Ô∏è <strong>Jam:‚òÖ</strong> ${jam} WIB</div>`;
            detailHTML += `<div class="info-item">üÜî <strong>Refid:‚òÖ</strong> ${transaction.refId}</div>`;
            detailHTML += `<div class="info-item">üí∞ <strong>Saldo Baru:‚òÖ</strong> ${formatRupiah(transaction.newBalance)}</div>`;
            detailHTML += `</div>`;

            document.getElementById('transactionDetail').innerHTML = detailHTML;

            // Build account details (same format as transaction detail)
            let accountHTML = '';
            if (transaction.items && transaction.items.length > 0) {
                accountHTML = '<div class="account-details-list">';
                transaction.items.forEach((account, index) => {
                    if (index > 0) accountHTML += '<hr class="account-divider">';
                    accountHTML += `
                        <div class="account-detail-item">
                            <div class="detail-line"><span class="detail-icon">üìß</span><span class="detail-label">Email:</span><span class="detail-value">${account.email || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üîê</span><span class="detail-label">Password:</span><span class="detail-value">${account.password || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üë§</span><span class="detail-label">Profil:</span><span class="detail-value">${account.profile || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üî¢</span><span class="detail-label">Pin:</span><span class="detail-value">${account.pin || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üîí</span><span class="detail-label">2FA:</span><span class="detail-value">${account.twofa || 'Tidak ada'}</span></div>
                        </div>
                    `;
                });
                accountHTML += '</div>';
                
                // Tambah info pembayaran di bawah
                accountHTML += `<div class="payment-info">`;
                accountHTML += `<div class="payment-row"><span>üí∞ <strong>Metode:</strong></span> <span>${transaction.metode || 'Saldo'}</span></div>`;
                accountHTML += `<div class="payment-row"><span>üíµ <strong>Total:</strong></span> <span>${formatRupiah(transaction.totalPrice || 0)}</span></div>`;
                accountHTML += `</div>`;
            } else {
                accountHTML = '<p class="empty-state">Detail akun tidak tersedia</p>';
            }

            document.getElementById('accountDetailsSection').innerHTML = accountHTML;
            
            // Parse and display SNK from receipt content
            let snkHTML = '';
            if (currentReceiptText) {
                const lines = currentReceiptText.split('\n');
                let inSnkSection = false;
                let snkLines = [];
                let snkTitle = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.includes('SNK PRODUK:') || line.includes('üìã SNK PRODUK:')) {
                        inSnkSection = true;
                        snkTitle = line.replace(/[*üìã]/g, '').replace('SNK PRODUK:', '').trim();
                        continue;
                    }
                    if (line.includes('END SNK') || line.includes('‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ')) {
                        inSnkSection = false;
                        break;
                    }
                    if (inSnkSection && line && !line.includes('SYARAT & KETENTUAN') && !line.includes('‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ')) {
                        snkLines.push(line.replace(/[*]/g, ''));
                    }
                }
                
                if (snkLines.length > 0) {
                    snkHTML = '<div class="snk-container">';
                    snkHTML += `<h3 class="snk-title">üìã SNK PRODUK: ${snkTitle || transaction.productName}</h3>`;
                    snkHTML += '<div class="snk-content">';
                    snkLines.forEach(line => {
                        if (line.trim()) {
                            // Format line dengan emoji dan styling
                            let formattedLine = line;
                            if (line.includes('‚úÖ')) {
                                formattedLine = `<div class="snk-item snk-allowed">${line}</div>`;
                            } else if (line.includes('üö´') || line.includes('dilarang')) {
                                formattedLine = `<div class="snk-item snk-prohibited">${line}</div>`;
                            } else if (line.startsWith('*') || line.match(/^[‚Ä¢\-\*]/)) {
                                formattedLine = `<div class="snk-item">${line.replace(/^[‚Ä¢\-\*]\s*/, '')}</div>`;
                            } else {
                                formattedLine = `<div class="snk-item">${line}</div>`;
                            }
                            snkHTML += formattedLine;
                        }
                    });
                    snkHTML += '</div></div>';
                }
            } else if (transaction.snk) {
                // Fallback to transaction.snk if receipt content not available
                snkHTML = '<div class="snk-container">';
                snkHTML += `<h3 class="snk-title">üìã SNK PRODUK: ${transaction.productName}</h3>`;
                snkHTML += '<div class="snk-content">';
                const snkLines = transaction.snk.split('\n');
                snkLines.forEach(line => {
                    if (line.trim()) {
                        let formattedLine = line;
                        if (line.includes('‚úÖ')) {
                            formattedLine = `<div class="snk-item snk-allowed">${line}</div>`;
                        } else if (line.includes('üö´') || line.includes('dilarang')) {
                            formattedLine = `<div class="snk-item snk-prohibited">${line}</div>`;
                        } else {
                            formattedLine = `<div class="snk-item">${line}</div>`;
                        }
                        snkHTML += formattedLine;
                    }
                });
                snkHTML += '</div></div>';
            }
            
            document.getElementById('snkSection').innerHTML = snkHTML;
            document.getElementById('successModal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            currentReceiptText = null;
            currentRefId = null;
        }

        async function copyPurchaseReceipt() {
            try {
                if (!currentReceiptText) {
                    showToast('Receipt tidak tersedia', 'error');
                    return;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(currentReceiptText);
                showToast('‚úÖ Receipt berhasil dicopy!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                
                // Fallback method for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentReceiptText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('‚úÖ Receipt berhasil dicopy!', 'success');
                } catch (fallbackError) {
                    showToast('‚ùå Gagal copy receipt', 'error');
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const purchaseModal = document.getElementById('purchaseModal');
            const successModal = document.getElementById('successModal');
            if (event.target === purchaseModal) {
                closePurchaseModal();
            }
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }

        // Mobile menu toggle
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuIcon = document.getElementById('menuIcon');
            navLinks.classList.toggle('active');
            menuIcon.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const navToggle = document.querySelector('.nav-toggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks.classList.contains('active') && 
                !navbar.contains(event.target)) {
                toggleMenu();
            }
        });

        // Initialize
        checkAuth();
        loadProducts();
    </script>
</body>
</html>

