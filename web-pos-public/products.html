<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Produk - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Payment Countdown in Navbar */
        .payment-countdown-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            margin: 0 auto;
            max-width: 280px;
        }
        
        .payment-countdown-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        .countdown-icon {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .countdown-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .countdown-label {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .countdown-timer {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* Payment Modal Content */
        .payment-modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .payment-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .payment-countdown-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .countdown-display {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 12px 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .countdown-warning {
            font-size: 0.9rem;
            font-weight: 600;
            min-height: 20px;
        }
        
        .order-info-box {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
        }
        
        .order-info-box h3 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .order-detail-row:last-child {
            border-bottom: none;
        }
        
        .order-detail-row.total-row {
            background: rgba(99, 102, 241, 0.1);
            padding: 16px;
            margin: 12px -20px -20px -20px;
            border-radius: 0 0 14px 14px;
            border-bottom: none;
        }
        
        .order-detail-row.total-row strong {
            font-size: 1.3rem;
            color: var(--primary);
        }
        
        .unique-code-info {
            margin-top: 12px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            text-align: center;
        }
        
        .qris-image-container {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }
        
        .qris-label {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .qris-image-wrapper {
            width: 100%;
            max-width: 350px;
            height: 350px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .error-message {
            color: #ef4444;
            font-weight: 600;
        }
        
        .payment-instructions {
            background: rgba(99, 102, 241, 0.05);
            padding: 20px;
            border-radius: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .payment-instructions h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
        }
        
        .payment-instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .payment-instructions li {
            margin-bottom: 12px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .payment-status-box {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }
        
        .status-icon {
            font-size: 2rem;
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .payment-countdown-indicator {
                padding: 6px 12px;
                gap: 8px;
                max-width: 220px;
            }
            
            .countdown-icon {
                font-size: 1.2rem;
            }
            
            .countdown-label {
                font-size: 0.7rem;
            }
            
            .countdown-timer {
                font-size: 0.9rem;
            }
            
            .countdown-display {
                font-size: 2rem;
                letter-spacing: 2px;
            }
            
            .qris-image-wrapper {
                height: 280px;
                max-width: 280px;
            }
            
            .payment-modal-content {
                max-width: 95%;
                padding: 16px;
            }
        }
        
        /* Product Card Pricing */
        .product-price-new {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .price-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .price-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .product-footer-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .price-value {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" id="mainNavbar" style="display: none;">
        <div class="nav-brand">ü§ñ GiHa Smart Bot</div>
        
        <!-- Payment Countdown Indicator -->
        <div id="paymentCountdown" class="payment-countdown-indicator" style="display: none;" onclick="reopenPaymentModal()">
            <span class="countdown-icon">‚è∞</span>
            <div class="countdown-content">
                <div class="countdown-label">Menunggu Pembayaran</div>
                <div class="countdown-timer" id="navCountdownTimer">--:--</div>
            </div>
        </div>
        
        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle menu">
            <span id="menuIcon">‚ò∞</span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard">Dashboard</a>
            <a href="/products" class="active">Produk</a>
            <a href="/admin">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Products Hero Header -->
        <div class="products-hero">
            <div class="products-hero-content">
                <div class="hero-badge">üõçÔ∏è Shop</div>
                <h1 class="products-hero-title">Produk Digital</h1>
                <p class="products-hero-subtitle">Pilih produk terbaik untuk kebutuhan Anda</p>
            </div>
            <div class="balance-widget">
                <div class="balance-widget-icon">üí∞</div>
                <div class="balance-widget-content">
                    <span class="balance-widget-label">Saldo Anda</span>
                    <strong class="balance-widget-value" id="userBalance">Rp 0</strong>
                </div>
            </div>
        </div>

        <!-- Modern Search Bar -->
        <div class="search-container-modern">
            <div class="search-icon">üîç</div>
            <input type="text" id="searchInput" class="search-input-modern" placeholder="Cari produk yang Anda butuhkan..." onkeyup="filterProducts()">
            <div class="search-animation"></div>
        </div>

        <!-- Products Grid with New Design -->
        <div id="productGrid" class="product-grid-modern">
            <div class="loading-state-modern">
                <div class="loader-spinner"></div>
                <p>Memuat produk...</p>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePurchaseModal()">&times;</span>
            <h2>Konfirmasi Pembelian</h2>
            
            <div class="product-detail">
                <h3 id="modalProductName"></h3>
                <p id="modalProductDesc"></p>
            </div>

            <div class="form-group">
                <label for="quantity">Jumlah</label>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()">
            </div>

            <div class="purchase-summary">
                <div class="summary-row">
                    <span>Harga per item:</span>
                    <span id="pricePerItem">Rp 0</span>
                </div>
                <div class="summary-row">
                    <span>Jumlah:</span>
                    <span id="summaryQty">1</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="totalPrice">Rp 0</span>
                </div>
            </div>
            
            <!-- User Balance Info -->
            <div class="user-balance-info" style="background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 12px; margin: 16px 0; text-align: center;">
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 4px;">Saldo Anda</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="modalUserBalance">Rp 0</div>
            </div>

            <div id="modalAlert" class="alert"></div>

            <!-- Payment Method Buttons (1-Step Direct Purchase) -->
            <div class="payment-buttons-container" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                <button class="btn-payment-saldo" onclick="confirmPurchase('saldo')">
                    <span style="font-size: 1.5rem;">üí∞</span>
                    <div style="text-align: left;">
                        <div style="font-size: 1.1rem;">Bayar Pakai Saldo</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Langsung dari saldo akun Anda</div>
                    </div>
                </button>
                
                <button class="btn-payment-qris" onclick="confirmPurchase('buynow')">
                    <span style="font-size: 1.5rem;">üí≥</span>
                    <div style="text-align: left;">
                        <div style="font-size: 1.1rem;">Bayar via QRIS</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Otomatis & Instant</div>
                    </div>
                </button>
            </div>
            
            <style>
                .btn-payment-saldo,
                .btn-payment-qris {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 16px 24px;
                    border-radius: 12px;
                    font-size: 1rem;
                    font-weight: 700;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
                    width: 100%;
                }
                
                .btn-payment-qris {
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    box-shadow: 0 4px 16px rgba(245, 87, 108, 0.3);
                }
                
                .btn-payment-saldo:hover:not(:disabled) {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
                }
                
                .btn-payment-qris:hover:not(:disabled) {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 24px rgba(245, 87, 108, 0.4);
                }
                
                .btn-payment-saldo:active:not(:disabled),
                .btn-payment-qris:active:not(:disabled) {
                    transform: translateY(0);
                }
                
                .btn-payment-saldo:disabled,
                .btn-payment-qris:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }
            </style>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content transaction-modal-content">
            <div class="modal-header">
                <h2>Pembelian Berhasil!</h2>
                <div class="modal-header-actions">
                    <button class="btn-copy btn-copy-header" onclick="copyPurchaseReceipt()">
                        üìã Copy Receipt
                    </button>
                    <span class="modal-close" onclick="closeSuccessModal()">&times;</span>
                </div>
            </div>
            
            <div class="modal-body">
                <div id="transactionDetail" class="transaction-detail"></div>
                <div id="accountDetailsSection" class="account-details-section"></div>
                <div id="snkSection" class="snk-section"></div>
            </div>
            
            <div class="modal-actions-bottom">
                <button class="btn-secondary" onclick="closeSuccessModal()">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal (QRIS) -->
    <div id="qrisPaymentModal" class="modal">
        <div class="modal-content payment-modal-content">
            <span class="modal-close" onclick="closeQrisPaymentModal()">&times;</span>
            <h2>Pembayaran QRIS</h2>
            
            <div class="payment-info-container">
                <!-- Countdown Timer -->
                <div class="payment-countdown-box">
                    <div class="countdown-label">‚è∞ Waktu tersisa</div>
                    <div class="countdown-display" id="qrisCountdown">30:00</div>
                    <div class="countdown-warning" id="countdownWarning"></div>
                </div>
                
                <!-- Order Info -->
                <div class="order-info-box">
                    <h3>Detail Pesanan</h3>
                    <div class="order-detail-row">
                        <span>Order ID:</span>
                        <strong id="qrisOrderId">-</strong>
                    </div>
                    <div class="order-detail-row">
                        <span>Produk:</span>
                        <strong id="qrisProductName">-</strong>
                    </div>
                    <div class="order-detail-row">
                        <span>Jumlah:</span>
                        <strong id="qrisQuantity">-</strong>
                    </div>
                    <div class="order-detail-row total-row">
                        <span>Total Bayar:</span>
                        <strong id="qrisTotalAmount">Rp 0</strong>
                    </div>
                    <div class="unique-code-info">
                        <small>üí° Termasuk kode unik: <span id="qrisUniqueCode">0</span></small>
                    </div>
                </div>
                
                <!-- QRIS Image -->
                <div class="qris-image-container">
                    <div class="qris-label">Scan QRIS di bawah ini:</div>
                    <div class="qris-image-wrapper" id="qrisImageWrapper">
                        <div class="loading-spinner">Memuat QR...</div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="payment-instructions">
                    <h4>üì± Cara Pembayaran:</h4>
                    <ol>
                        <li>Buka aplikasi mobile banking atau e-wallet Anda</li>
                        <li>Pilih menu <strong>Scan QR / QRIS</strong></li>
                        <li>Scan kode QR di atas</li>
                        <li>Konfirmasi pembayaran sejumlah <strong id="qrisTotalAmount2">Rp 0</strong></li>
                        <li>Tunggu notifikasi pembayaran berhasil</li>
                    </ol>
                </div>
                
                <!-- Payment Status -->
                <div class="payment-status-box" id="paymentStatusBox">
                    <div class="status-icon">üîÑ</div>
                    <div class="status-text">Menunggu pembayaran...</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn-secondary" onclick="closeQrisPaymentModal()" style="flex: 1;">
                    Tutup (Lanjutkan Nanti)
                </button>
                <button class="btn-danger" onclick="cancelPayment()" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                    ‚ùå Batalkan Pesanan
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let allProducts = [];
        let selectedProduct = null;
        let currentUserData = null;
        let pendingPaymentOrder = null;
        let countdownInterval = null;
        let paymentCheckInterval = null;
        let currentReceiptText = null;
        let currentRefId = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    // Guest mode - hide navbar and show login button instead of balance
                    currentUserData = null;
                    const navbar = document.getElementById('mainNavbar');
                    if (navbar) navbar.style.display = 'none';
                    
                    const balanceElement = document.getElementById('userBalance');
                    if (balanceElement) {
                        balanceElement.parentElement.innerHTML = `
                            <a href="/" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.5rem 1rem;">
                                üîê Login
                            </a>
                        `;
                    }
                    return;
                }

                // User is logged in - show navbar
                currentUserData = data.user;
                const navbar = document.getElementById('mainNavbar');
                if (navbar) navbar.style.display = 'flex';
                
                document.getElementById('userBalance').textContent = formatRupiah(data.user.saldo);

                // Show Admin tab if user is admin
                if (data.user.isAdmin) {
                    const adminLink = document.querySelector('a[href="/admin"]');
                    if (adminLink) adminLink.classList.add('show-admin');
                }

                // Load pending order if exists (untuk restore setelah reload)
                await loadPendingOrder();
            } catch (error) {
                console.error('Auth check failed:', error);
                // Guest mode - hide navbar and show login button
                currentUserData = null;
                const navbar = document.getElementById('mainNavbar');
                if (navbar) navbar.style.display = 'none';
                
                const balanceElement = document.getElementById('userBalance');
                if (balanceElement) {
                    balanceElement.parentElement.innerHTML = `
                        <a href="/" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.5rem 1rem;">
                            üîê Login
                        </a>
                    `;
                }
            }
        }

        async function loadPendingOrder() {
            try {
                const response = await fetch('/api/pending-order');
                const data = await response.json();

                if (data.success && data.hasPendingOrder && data.order) {
                    // Set pending order
                    pendingPaymentOrder = data.order;
                    
                    // Load QR image if available
                    if (data.order.qrisImageBase64) {
                        const qrisWrapper = document.getElementById('qrisImageWrapper');
                        if (qrisWrapper) {
                            qrisWrapper.innerHTML = `
                                <img src="data:image/png;base64,${data.order.qrisImageBase64}" 
                                     alt="QRIS Code" 
                                     style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px; background: white; padding: 10px;">
                            `;
                        }
                    }
                    
                    // Start countdown and payment checking
                    startPaymentCountdown();
                    startPaymentStatusCheck();
                    
                    // Show navbar countdown
                    showNavbarCountdown();
                    
                    console.log('‚úÖ Pending order restored from database');
                } else {
                    // No pending order, clear any existing intervals
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (paymentCheckInterval) clearInterval(paymentCheckInterval);
                    pendingPaymentOrder = null;
                    document.getElementById('paymentCountdown').style.display = 'none';
                }
            } catch (error) {
                console.error('Load pending order failed:', error);
                // Don't show error to user, just silently fail
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                if (!data.success) {
                    document.getElementById('productGrid').innerHTML = 
                        '<p class="empty-state">Gagal memuat produk</p>';
                    return;
                }

                allProducts = data.products;
                
                // Debug: log product data to check prices
                console.log('Loaded products:', allProducts);
                if (allProducts.length > 0) {
                    console.log('First product:', allProducts[0]);
                }
                
                displayProducts(allProducts);
            } catch (error) {
                console.error('Load products failed:', error);
                document.getElementById('productGrid').innerHTML = 
                    '<p class="empty-state">Terjadi kesalahan saat memuat produk</p>';
            }
        }

        // Generate consistent color based on product name
        function getProductColor(productName) {
            // Better hash function for better distribution
            let hash = 0;
            for (let i = 0; i < productName.length; i++) {
                const char = productName.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            // Use predefined vibrant color palette for better variety
            const colors = [
                // Blues & Purples
                'hsl(240, 70%, 55%)',  // Deep Blue
                'hsl(260, 70%, 60%)',  // Purple
                'hsl(280, 65%, 55%)',  // Violet
                'hsl(220, 75%, 60%)',  // Sky Blue
                
                // Greens & Teals
                'hsl(150, 70%, 50%)',  // Teal
                'hsl(160, 75%, 45%)',  // Turquoise
                'hsl(140, 70%, 50%)',  // Green
                'hsl(180, 70%, 50%)',  // Cyan
                
                // Oranges & Reds
                'hsl(15, 85%, 55%)',   // Orange Red
                'hsl(25, 80%, 55%)',   // Orange
                'hsl(0, 75%, 55%)',    // Red
                'hsl(350, 75%, 55%)',  // Pink Red
                
                // Yellows & Golds
                'hsl(45, 85%, 55%)',   // Gold
                'hsl(35, 80%, 55%)',   // Amber
                'hsl(50, 85%, 60%)',   // Yellow
                
                // Pinks & Magentas
                'hsl(320, 70%, 60%)',  // Magenta
                'hsl(330, 70%, 60%)',  // Pink
                'hsl(300, 65%, 60%)',  // Fuchsia
                
                // Additional vibrant colors
                'hsl(200, 75%, 55%)',  // Light Blue
                'hsl(190, 75%, 50%)',  // Aqua
                'hsl(170, 70%, 50%)',  // Mint
            ];
            
            // Select color based on hash
            const colorIndex = Math.abs(hash) % colors.length;
            return colors[colorIndex];
        }
        
        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');

            if (products.length === 0) {
                productGrid.innerHTML = `
                    <div class="empty-state-modern">
                        <div class="empty-icon">üì¶</div>
                        <h3>Tidak ada produk</h3>
                        <p>Produk akan tersedia segera</p>
                    </div>`;
                return;
            }

            productGrid.innerHTML = products.map((product, index) => {
                // Ensure price is valid
                const productPrice = product.price || product.basePrice || 0;
                const formattedPrice = productPrice > 0 ? formatRupiah(productPrice) : 'Hubungi Admin';
                
                // Get consistent color for this product
                const productColor = getProductColor(product.name);
                
                // Create darker variant for gradient end
                const colorMatch = productColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                let darkerColor = productColor;
                if (colorMatch) {
                    const hue = colorMatch[1];
                    const sat = colorMatch[2];
                    const light = Math.max(35, parseInt(colorMatch[3]) - 15); // Darker by 15%
                    darkerColor = `hsl(${hue}, ${sat}%, ${light}%)`;
                }
                
                return `
                <div class="product-card-new" style="animation-delay: ${index * 0.1}s" onclick="openPurchaseModal('${product.id}')">
                    <div class="product-card-shine"></div>
                    <div class="product-image-placeholder" style="background: linear-gradient(135deg, ${productColor} 0%, ${darkerColor} 100%); box-shadow: 0 4px 20px ${productColor}40;">
                        <span class="product-emoji" style="font-size: 3rem;">üì¶</span>
                        ${product.stock > 0 ? 
                            `<div class="stock-badge available">‚úì Tersedia</div>` : 
                            `<div class="stock-badge unavailable">‚úï Habis</div>`
                        }
                    </div>
                    <div class="product-content-new">
                        <div class="product-category-badge" style="background: ${productColor}25; color: ${productColor}; border: 1px solid ${productColor}40;">Digital</div>
                        <h3 class="product-title-new">${product.name}</h3>
                        <p class="product-desc-new">${product.description || 'Produk digital berkualitas'}</p>
                        <div class="product-meta-new">
                            <div class="product-stock-info">
                                <span class="stock-icon">üìä</span>
                                <span>${product.stock} stok</span>
                            </div>
                        </div>
                    </div>
                    <div class="product-footer-new">
                        <div class="product-price-new">
                            <span class="price-label">Harga</span>
                            <span class="price-value">${formattedPrice}</span>
                        </div>
                        <button class="btn-buy-new" onclick="event.stopPropagation(); openPurchaseModal('${product.id}')" ${product.stock === 0 ? 'disabled' : ''}>
                            <span class="btn-icon">üõí</span>
                            <span>Beli Sekarang</span>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                (p.description && p.description.toLowerCase().includes(searchTerm))
            );
            displayProducts(filtered);
        }

        function openPurchaseModal(productId) {
            selectedProduct = allProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            // Check if user is logged in
            if (!currentUserData) {
                // Guest mode - redirect to login
                if (confirm('Anda harus login terlebih dahulu untuk melakukan pembelian. Ingin login sekarang?')) {
                    window.location.href = '/';
                }
                return;
            }

            // Check if there's pending order
            const hasPendingOrder = pendingPaymentOrder !== null;
            
            if (hasPendingOrder) {
                showModalAlert('Anda sedang memiliki order yang belum selesai. Silakan selesaikan atau batalkan terlebih dahulu.', 'error');
                // Still show modal but disable buttons
            }

            // Clear any previous alerts (unless we just set one)
            if (!hasPendingOrder) {
                const alertBox = document.getElementById('modalAlert');
                alertBox.className = 'alert';
                alertBox.textContent = '';
            }

            // Update modal content
            document.getElementById('modalProductName').textContent = selectedProduct.name;
            document.getElementById('modalProductDesc').textContent = 
                selectedProduct.description || 'Tidak ada deskripsi';
            document.getElementById('pricePerItem').textContent = formatRupiah(selectedProduct.price);
            document.getElementById('quantity').value = 1;
            document.getElementById('quantity').max = selectedProduct.stock;
            
            // Show user balance in modal
            document.getElementById('modalUserBalance').textContent = formatRupiah(currentUserData.saldo || 0);
            
            // Disable/enable payment buttons based on pending order
            const btnSaldo = document.querySelector('.btn-payment-saldo');
            const btnQris = document.querySelector('.btn-payment-qris');
            
            if (hasPendingOrder) {
                // Disable both buttons
                if (btnSaldo) {
                    btnSaldo.disabled = true;
                    btnSaldo.style.opacity = '0.6';
                    btnSaldo.style.cursor = 'not-allowed';
                    btnSaldo.title = 'Selesaikan atau batalkan order yang sedang berlangsung terlebih dahulu';
                }
                if (btnQris) {
                    btnQris.disabled = true;
                    btnQris.style.opacity = '0.6';
                    btnQris.style.cursor = 'not-allowed';
                    btnQris.title = 'Selesaikan atau batalkan order yang sedang berlangsung terlebih dahulu';
                }
            } else {
                // Enable both buttons
                if (btnSaldo) {
                    btnSaldo.disabled = false;
                    btnSaldo.style.opacity = '1';
                    btnSaldo.style.cursor = 'pointer';
                    btnSaldo.title = '';
                }
                if (btnQris) {
                    btnQris.disabled = false;
                    btnQris.style.opacity = '1';
                    btnQris.style.cursor = 'pointer';
                    btnQris.title = '';
                }
            }
            
            updateTotalPrice();
            
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'none';
            selectedProduct = null;
            
            // Clear alert
            const alertBox = document.getElementById('modalAlert');
            if (alertBox) {
                alertBox.className = 'alert';
                alertBox.textContent = '';
            }
            
            // Enable buttons if no pending order (untuk next purchase)
            if (!pendingPaymentOrder) {
                const btnSaldo = document.querySelector('.btn-payment-saldo');
                const btnQris = document.querySelector('.btn-payment-qris');
                if (btnSaldo) {
                    btnSaldo.disabled = false;
                    btnSaldo.style.opacity = '1';
                    btnSaldo.style.cursor = 'pointer';
                    btnSaldo.title = '';
                }
                if (btnQris) {
                    btnQris.disabled = false;
                    btnQris.style.opacity = '1';
                    btnQris.style.cursor = 'pointer';
                    btnQris.title = '';
                }
            }
        }

        function updateTotalPrice() {
            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const total = selectedProduct.price * quantity;

            document.getElementById('summaryQty').textContent = quantity;
            document.getElementById('totalPrice').textContent = formatRupiah(total);
        }

        function showModalAlert(message, type = 'error') {
            const alertBox = document.getElementById('modalAlert');
            alertBox.textContent = message;
            alertBox.className = `alert ${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        async function confirmPurchase(paymentMethod) {
            // Check if user is logged in
            if (!currentUserData) {
                showModalAlert('Anda harus login terlebih dahulu untuk melakukan pembelian');
                if (confirm('Ingin login sekarang?')) {
                    window.location.href = '/';
                }
                return;
            }

            if (!selectedProduct) return;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;

            if (quantity < 1) {
                showModalAlert('Jumlah minimal 1');
                return;
            }

            if (quantity > selectedProduct.stock) {
                showModalAlert('Jumlah melebihi stok tersedia');
                return;
            }

            // Disable both buttons during processing
            const btnSaldo = document.querySelector('.btn-payment-saldo');
            const btnQris = document.querySelector('.btn-payment-qris');
            const activeButton = paymentMethod === 'saldo' ? btnSaldo : btnQris;
            const originalHTML = activeButton.innerHTML;
            
            btnSaldo.disabled = true;
            btnSaldo.style.opacity = '0.6';
            btnSaldo.style.cursor = 'not-allowed';
            btnQris.disabled = true;
            btnQris.style.opacity = '0.6';
            btnQris.style.cursor = 'not-allowed';
            activeButton.innerHTML = '<span class="loading"></span> Memproses...';

            try {
                // Choose endpoint based on payment method
                const endpoint = paymentMethod === 'saldo' ? '/api/purchase' : '/api/buynow';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: selectedProduct.id,
                        quantity: quantity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closePurchaseModal();
                    
                    // Handle different responses for saldo vs buynow
                    if (paymentMethod === 'saldo') {
                        // Pembelian dengan saldo langsung selesai, tidak ada pending order
                        // Pastikan pendingPaymentOrder tetap null
                        pendingPaymentOrder = null;
                        
                        // Enable payment buttons (untuk next purchase)
                        btnSaldo.disabled = false;
                        btnSaldo.style.opacity = '1';
                        btnSaldo.style.cursor = 'pointer';
                        btnQris.disabled = false;
                        btnQris.style.opacity = '1';
                        btnQris.style.cursor = 'pointer';
                        
                        // Show success modal with receipt
                        showSuccessModal(data.transaction);
                    } else {
                        // Show QRIS payment modal (no redirect!)
                        showToast('‚úÖ Order berhasil dibuat!', 'success');
                        showQrisPaymentModal(data);
                    }
                    
                    // Reload products and balance
                    await loadProducts();
                    await checkAuth();
                } else {
                    showModalAlert(data.message || 'Pembelian gagal');
                    // Reset buttons
                    activeButton.innerHTML = originalHTML;
                    btnSaldo.disabled = false;
                    btnSaldo.style.opacity = '1';
                    btnSaldo.style.cursor = 'pointer';
                    btnQris.disabled = false;
                    btnQris.style.opacity = '1';
                    btnQris.style.cursor = 'pointer';
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showModalAlert('Terjadi kesalahan saat memproses pembelian');
                // Reset buttons
                activeButton.innerHTML = originalHTML;
                btnSaldo.disabled = false;
                btnSaldo.style.opacity = '1';
                btnSaldo.style.cursor = 'pointer';
                btnQris.disabled = false;
                btnQris.style.opacity = '1';
                btnQris.style.cursor = 'pointer';
            }
        }
        
        function showPaymentModal(data) {
            // Placeholder for payment modal (QRIS/Transfer)
            // You can implement this based on your payment gateway
            showToast('Fitur payment gateway akan segera ditambahkan', 'info');
            console.log('Payment data:', data);
        }

        function showSuccessModal(transaction) {
            // Store receipt content globally
            currentReceiptText = transaction.receiptContent || null;
            currentRefId = transaction.refId;

            // Parse tanggal dan jam
            const dateTime = transaction.date ? transaction.date.split(' ') : ['', ''];
            const tanggal = dateTime[0] || 'N/A';
            const jam = dateTime[1] || transaction.time || 'N/A';

            // Build account info header (same format as transaction detail)
            let detailHTML = '<div class="account-info-header">';
            detailHTML += `<h3>Account Information</h3>`;
            detailHTML += `<div class="info-item">üì¶ <strong>Produk:‚òÖ</strong> ${transaction.productName}</div>`;
            detailHTML += `<div class="info-item">üìÖ <strong>Tanggal:‚òÖ</strong> ${tanggal}</div>`;
            detailHTML += `<div class="info-item">‚è±Ô∏è <strong>Jam:‚òÖ</strong> ${jam} WIB</div>`;
            detailHTML += `<div class="info-item">üÜî <strong>Refid:‚òÖ</strong> ${transaction.refId}</div>`;
            detailHTML += `<div class="info-item">üí∞ <strong>Saldo Baru:‚òÖ</strong> ${formatRupiah(transaction.newBalance)}</div>`;
            detailHTML += `</div>`;

            document.getElementById('transactionDetail').innerHTML = detailHTML;

            // Build account details (same format as transaction detail)
            let accountHTML = '';
            if (transaction.items && transaction.items.length > 0) {
                accountHTML = '<div class="account-details-list">';
                transaction.items.forEach((account, index) => {
                    if (index > 0) accountHTML += '<hr class="account-divider">';
                    accountHTML += `
                        <div class="account-detail-item">
                            <div class="detail-line"><span class="detail-icon">üìß</span><span class="detail-label">Email:</span><span class="detail-value">${account.email || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üîê</span><span class="detail-label">Password:</span><span class="detail-value">${account.password || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üë§</span><span class="detail-label">Profil:</span><span class="detail-value">${account.profile || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üî¢</span><span class="detail-label">Pin:</span><span class="detail-value">${account.pin || 'Tidak ada'}</span></div>
                            <div class="detail-line"><span class="detail-icon">üîí</span><span class="detail-label">2FA:</span><span class="detail-value">${account.twofa || 'Tidak ada'}</span></div>
                        </div>
                    `;
                });
                accountHTML += '</div>';
                
                // Tambah info pembayaran di bawah
                accountHTML += `<div class="payment-info">`;
                accountHTML += `<div class="payment-row"><span>üí∞ <strong>Metode:</strong></span> <span>${transaction.metode || 'Saldo'}</span></div>`;
                accountHTML += `<div class="payment-row"><span>üíµ <strong>Total:</strong></span> <span>${formatRupiah(transaction.totalPrice || 0)}</span></div>`;
                accountHTML += `</div>`;
            } else {
                accountHTML = '<p class="empty-state">Detail akun tidak tersedia</p>';
            }

            document.getElementById('accountDetailsSection').innerHTML = accountHTML;
            
            // Parse and display SNK from receipt content
            let snkHTML = '';
            if (currentReceiptText) {
                const lines = currentReceiptText.split('\n');
                let inSnkSection = false;
                let snkLines = [];
                let snkTitle = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.includes('SNK PRODUK:') || line.includes('üìã SNK PRODUK:')) {
                        inSnkSection = true;
                        snkTitle = line.replace(/[*üìã]/g, '').replace('SNK PRODUK:', '').trim();
                        continue;
                    }
                    if (line.includes('END SNK') || line.includes('‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ')) {
                        inSnkSection = false;
                        break;
                    }
                    if (inSnkSection && line && !line.includes('SYARAT & KETENTUAN') && !line.includes('‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ')) {
                        snkLines.push(line.replace(/[*]/g, ''));
                    }
                }
                
                if (snkLines.length > 0) {
                    snkHTML = '<div class="snk-container">';
                    snkHTML += `<h3 class="snk-title">üìã SNK PRODUK: ${snkTitle || transaction.productName}</h3>`;
                    snkHTML += '<div class="snk-content">';
                    snkLines.forEach(line => {
                        if (line.trim()) {
                            // Format line dengan emoji dan styling
                            let formattedLine = line;
                            if (line.includes('‚úÖ')) {
                                formattedLine = `<div class="snk-item snk-allowed">${line}</div>`;
                            } else if (line.includes('üö´') || line.includes('dilarang')) {
                                formattedLine = `<div class="snk-item snk-prohibited">${line}</div>`;
                            } else if (line.startsWith('*') || line.match(/^[‚Ä¢\-\*]/)) {
                                formattedLine = `<div class="snk-item">${line.replace(/^[‚Ä¢\-\*]\s*/, '')}</div>`;
                            } else {
                                formattedLine = `<div class="snk-item">${line}</div>`;
                            }
                            snkHTML += formattedLine;
                        }
                    });
                    snkHTML += '</div></div>';
                }
            } else if (transaction.snk) {
                // Fallback to transaction.snk if receipt content not available
                snkHTML = '<div class="snk-container">';
                snkHTML += `<h3 class="snk-title">üìã SNK PRODUK: ${transaction.productName}</h3>`;
                snkHTML += '<div class="snk-content">';
                const snkLines = transaction.snk.split('\n');
                snkLines.forEach(line => {
                    if (line.trim()) {
                        let formattedLine = line;
                        if (line.includes('‚úÖ')) {
                            formattedLine = `<div class="snk-item snk-allowed">${line}</div>`;
                        } else if (line.includes('üö´') || line.includes('dilarang')) {
                            formattedLine = `<div class="snk-item snk-prohibited">${line}</div>`;
                        } else {
                            formattedLine = `<div class="snk-item">${line}</div>`;
                        }
                        snkHTML += formattedLine;
                    }
                });
                snkHTML += '</div></div>';
            }
            
            document.getElementById('snkSection').innerHTML = snkHTML;
            document.getElementById('successModal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            currentReceiptText = null;
            currentRefId = null;
        }

        async function copyPurchaseReceipt() {
            try {
                if (!currentReceiptText) {
                    showToast('Receipt tidak tersedia', 'error');
                    return;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(currentReceiptText);
                showToast('‚úÖ Receipt berhasil dicopy!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                
                // Fallback method for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentReceiptText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('‚úÖ Receipt berhasil dicopy!', 'success');
                } catch (fallbackError) {
                    showToast('‚ùå Gagal copy receipt', 'error');
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const purchaseModal = document.getElementById('purchaseModal');
            const successModal = document.getElementById('successModal');
            if (event.target === purchaseModal) {
                closePurchaseModal();
            }
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }

        // Mobile menu toggle
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuIcon = document.getElementById('menuIcon');
            navLinks.classList.toggle('active');
            menuIcon.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const navToggle = document.querySelector('.nav-toggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks.classList.contains('active') && 
                !navbar.contains(event.target)) {
                toggleMenu();
            }
        });

        // ===== QRIS PAYMENT MODAL FUNCTIONS =====
        
        function showQrisPaymentModal(data) {
            // Store order data
            pendingPaymentOrder = data.order;
            
            // Clear any existing intervals
            if (countdownInterval) clearInterval(countdownInterval);
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            
            // Populate modal with order data
            document.getElementById('qrisOrderId').textContent = data.order.orderId || '-';
            document.getElementById('qrisProductName').textContent = data.order.productName || '-';
            document.getElementById('qrisQuantity').textContent = data.order.jumlah || '1';
            document.getElementById('qrisTotalAmount').textContent = formatRupiah(data.order.totalAmount || 0);
            document.getElementById('qrisTotalAmount2').textContent = formatRupiah(data.order.totalAmount || 0);
            document.getElementById('qrisUniqueCode').textContent = formatRupiah(data.order.uniqueCode || 0);
            
            // Load QRIS image
            const qrisWrapper = document.getElementById('qrisImageWrapper');
            if (data.payment && data.payment.qrisImageBase64) {
                qrisWrapper.innerHTML = `
                    <img src="data:image/png;base64,${data.payment.qrisImageBase64}" 
                         alt="QRIS Code" 
                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px; background: white; padding: 10px;">
                `;
            } else {
                qrisWrapper.innerHTML = '<div class="error-message">‚ö†Ô∏è Gagal memuat QR Code</div>';
            }
            
            // Show modal
            document.getElementById('qrisPaymentModal').style.display = 'flex';
            
            // Start countdown and payment checking
            startPaymentCountdown();
            startPaymentStatusCheck();
        }
        
        function closeQrisPaymentModal() {
            document.getElementById('qrisPaymentModal').style.display = 'none';
            
            // Keep countdown running in navbar if there's pending payment
            if (pendingPaymentOrder) {
                showNavbarCountdown();
            }
        }
        
        function reopenPaymentModal() {
            if (!pendingPaymentOrder) return;
            
            // Re-populate modal with existing order data
            document.getElementById('qrisOrderId').textContent = pendingPaymentOrder.orderId || '-';
            document.getElementById('qrisProductName').textContent = pendingPaymentOrder.productName || '-';
            document.getElementById('qrisQuantity').textContent = pendingPaymentOrder.jumlah || '1';
            document.getElementById('qrisTotalAmount').textContent = formatRupiah(pendingPaymentOrder.totalAmount || 0);
            document.getElementById('qrisTotalAmount2').textContent = formatRupiah(pendingPaymentOrder.totalAmount || 0);
            document.getElementById('qrisUniqueCode').textContent = formatRupiah(pendingPaymentOrder.uniqueCode || 0);
            
            // Load QR image if not already loaded, or reload it
            const qrisWrapper = document.getElementById('qrisImageWrapper');
            if (pendingPaymentOrder.qrisImageBase64) {
                // Use cached QR image if available
                qrisWrapper.innerHTML = `
                    <img src="data:image/png;base64,${pendingPaymentOrder.qrisImageBase64}" 
                         alt="QRIS Code" 
                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px; background: white; padding: 10px;">
                `;
            } else {
                // Reload QR image from API
                loadQrisImage();
            }
            
            // Hide navbar countdown
            document.getElementById('paymentCountdown').style.display = 'none';
            
            // Show modal
            document.getElementById('qrisPaymentModal').style.display = 'flex';
        }
        
        async function loadQrisImage() {
            if (!pendingPaymentOrder || !pendingPaymentOrder.orderId) return;
            
            try {
                const response = await fetch(`/api/order/${pendingPaymentOrder.orderId}`);
                const data = await response.json();
                
                if (data.success && data.order.qrisImageBase64) {
                    // Store QR image in pendingPaymentOrder for future use
                    pendingPaymentOrder.qrisImageBase64 = data.order.qrisImageBase64;
                    
                    const qrisWrapper = document.getElementById('qrisImageWrapper');
                    qrisWrapper.innerHTML = `
                        <img src="data:image/png;base64,${data.order.qrisImageBase64}" 
                             alt="QRIS Code" 
                             style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px; background: white; padding: 10px;">
                    `;
                }
            } catch (error) {
                console.error('Error loading QRIS image:', error);
            }
        }
        
        function startPaymentCountdown() {
            if (!pendingPaymentOrder || !pendingPaymentOrder.createdAt) return;
            
            const expirationTime = pendingPaymentOrder.createdAt + (30 * 60 * 1000); // 30 minutes
            
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = expirationTime - now;
                
                if (timeLeft <= 0) {
                    // Expired
                    clearInterval(countdownInterval);
                    clearInterval(paymentCheckInterval);
                    document.getElementById('qrisCountdown').textContent = '00:00';
                    document.getElementById('navCountdownTimer').textContent = '00:00';
                    document.getElementById('countdownWarning').innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è Waktu habis!</span>';
                    document.getElementById('paymentStatusBox').innerHTML = `
                        <div class="status-icon">‚è∞</div>
                        <div class="status-text">Pembayaran expired. Silakan buat order baru.</div>
                    `;
                    pendingPaymentOrder = null;
                    document.getElementById('paymentCountdown').style.display = 'none';
                    
                    // Enable payment buttons
                    const btnSaldo = document.querySelector('.btn-payment-saldo');
                    const btnQris = document.querySelector('.btn-payment-qris');
                    if (btnSaldo) {
                        btnSaldo.disabled = false;
                        btnSaldo.style.opacity = '1';
                        btnSaldo.style.cursor = 'pointer';
                        btnSaldo.title = '';
                    }
                    if (btnQris) {
                        btnQris.disabled = false;
                        btnQris.style.opacity = '1';
                        btnQris.style.cursor = 'pointer';
                        btnQris.title = '';
                    }
                    
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                document.getElementById('qrisCountdown').textContent = timeString;
                document.getElementById('navCountdownTimer').textContent = timeString;
                
                // Show warning if less than 5 minutes
                if (minutes < 5) {
                    document.getElementById('countdownWarning').innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Segera lakukan pembayaran</span>';
                } else {
                    document.getElementById('countdownWarning').innerHTML = '';
                }
            }, 1000);
        }
        
        function showNavbarCountdown() {
            document.getElementById('paymentCountdown').style.display = 'flex';
        }
        
        async function cancelPayment() {
            if (!pendingPaymentOrder) return;
            
            // Confirm cancellation
            if (!confirm('Apakah Anda yakin ingin membatalkan pesanan ini?')) {
                return;
            }
            
            try {
                // Call backend to cancel order
                const response = await fetch(`/api/cancel-order/${pendingPaymentOrder.orderId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Stop all intervals
                    clearInterval(countdownInterval);
                    clearInterval(paymentCheckInterval);
                    
                    // Reset pending order
                    pendingPaymentOrder = null;
                    
                    // Close modal and hide navbar countdown
                    document.getElementById('qrisPaymentModal').style.display = 'none';
                    document.getElementById('paymentCountdown').style.display = 'none';
                    
                    // Reset payment buttons
                    const btnSaldo = document.querySelector('.btn-payment-saldo');
                    const btnQris = document.querySelector('.btn-payment-qris');
                    if (btnSaldo) {
                        btnSaldo.disabled = false;
                        btnSaldo.style.opacity = '1';
                        btnSaldo.style.cursor = 'pointer';
                        btnSaldo.innerHTML = `
                            <span style="font-size: 1.5rem;">üí∞</span>
                            <div style="text-align: left;">
                                <div style="font-size: 1.1rem;">Bayar Pakai Saldo</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Langsung dari saldo akun Anda</div>
                            </div>
                        `;
                    }
                    if (btnQris) {
                        btnQris.disabled = false;
                        btnQris.style.opacity = '1';
                        btnQris.style.cursor = 'pointer';
                        btnQris.innerHTML = `
                            <span style="font-size: 1.5rem;">üí≥</span>
                            <div style="text-align: left;">
                                <div style="font-size: 1.1rem;">Bayar via QRIS</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Otomatis & Instant</div>
                            </div>
                        `;
                    }
                    
                    showToast('‚úÖ Pesanan berhasil dibatalkan', 'success');
                    
                    // Reload products
                    await loadProducts();
                } else {
                    showToast('‚ùå Gagal membatalkan pesanan: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error canceling payment:', error);
                showToast('‚ùå Terjadi kesalahan saat membatalkan pesanan', 'error');
            }
        }
        
        function startPaymentStatusCheck() {
            if (!pendingPaymentOrder || !pendingPaymentOrder.orderId) return;
            
            // Check immediately
            checkPaymentStatus();
            
            // Then check every 5 seconds
            paymentCheckInterval = setInterval(() => {
                checkPaymentStatus();
            }, 5000);
        }
        
        async function checkPaymentStatus() {
            if (!pendingPaymentOrder || !pendingPaymentOrder.orderId) return;
            
            try {
                const response = await fetch(`/api/order/${pendingPaymentOrder.orderId}`);
                const data = await response.json();
                
                if (data.success && data.order.status === 'completed') {
                    // Payment successful!
                    clearInterval(countdownInterval);
                    clearInterval(paymentCheckInterval);
                    
                    // Reset payment buttons to enabled state
                    const btnSaldo = document.querySelector('.btn-payment-saldo');
                    const btnQris = document.querySelector('.btn-payment-qris');
                    if (btnSaldo) {
                        btnSaldo.disabled = false;
                        btnSaldo.style.opacity = '1';
                        btnSaldo.style.cursor = 'pointer';
                        btnSaldo.innerHTML = `
                            <span style="font-size: 1.5rem;">üí∞</span>
                            <div style="text-align: left;">
                                <div style="font-size: 1.1rem;">Bayar Pakai Saldo</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Langsung dari saldo akun Anda</div>
                            </div>
                        `;
                    }
                    if (btnQris) {
                        btnQris.disabled = false;
                        btnQris.style.opacity = '1';
                        btnQris.style.cursor = 'pointer';
                        btnQris.innerHTML = `
                            <span style="font-size: 1.5rem;">üí≥</span>
                            <div style="text-align: left;">
                                <div style="font-size: 1.1rem;">Bayar via QRIS</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Otomatis & Instant</div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('paymentStatusBox').innerHTML = `
                        <div class="status-icon">‚úÖ</div>
                        <div class="status-text" style="color: #10b981; font-weight: 700;">Pembayaran Berhasil!</div>
                    `;
                    
                    document.getElementById('qrisPaymentModal').style.display = 'none';
                    document.getElementById('paymentCountdown').style.display = 'none';
                    
                    showToast('üéâ Pembayaran berhasil! Produk sedang diproses...', 'success');
                    
                    // Transform data for showSuccessModal
                    if (data.order.receipt || data.order.receiptText) {
                        // Reload user data for newBalance
                        await checkAuth();
                        
                        const transformedData = {
                            receiptContent: data.order.receiptText || data.order.receipt,
                            refId: data.order.reffId,
                            productName: data.order.productName,
                            date: new Date().toLocaleDateString('id-ID') + ' ' + new Date().toLocaleTimeString('id-ID'),
                            metode: 'QRIS',
                            totalPrice: data.order.totalAmount,
                            newBalance: currentUserData?.saldo || 0,
                            items: data.order.account || [],
                            snk: data.order.snk || ''
                        };
                        
                        setTimeout(() => {
                            showSuccessModal(transformedData);
                        }, 1000);
                    } else {
                        // No receipt, just show toast and reload
                        showToast('‚úÖ Transaksi berhasil! Detail akan segera tersedia.', 'success');
                    }
                    
                    pendingPaymentOrder = null;
                    
                    // Reload products and balance
                    await loadProducts();
                    await checkAuth();
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
            }
        }
        
        // Initialize
        checkAuth();
        loadProducts();
    </script>
</body>
</html>

