<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dashboard - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">ü§ñ GiHa Smart Bot</div>
        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle menu">
            <span id="menuIcon">‚ò∞</span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard" class="active">Dashboard</a>
            <a href="/products">Produk</a>
            <a href="/admin">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Hero Section with Liquid Glass Effect -->
        <div class="hero-aurora liquid-glass-elastic">
            <div class="aurora-particles"></div>
            <div class="hero-content-new">
                <div class="welcome-section">
                    <span class="welcome-emoji">üëã</span>
                    <h1 class="hero-title-aurora chromatic-text" data-text="Dashboard">Dashboard</h1>
                    <p class="hero-subtitle-aurora">Kelola bisnis Anda dengan teknologi terdepan</p>
                </div>
            </div>
            <div class="stats-hero-grid">
                <div class="stat-hero-card frosted-card glow-aurora">
                    <div class="stat-hero-icon">üí∞</div>
                    <div class="stat-hero-content">
                        <span class="stat-hero-label">Total Saldo</span>
                        <span class="stat-hero-value" id="userBalance">Rp 0</span>
                    </div>
                </div>
                <div class="stat-hero-card frosted-card glow-pink">
                    <div class="stat-hero-icon">üë§</div>
                    <div class="stat-hero-content">
                        <span class="stat-hero-label">Status</span>
                        <span class="stat-hero-value" id="userRole">-</span>
                    </div>
                </div>
                <div class="stat-hero-card frosted-card glow-green">
                    <div class="stat-hero-icon">üì±</div>
                    <div class="stat-hero-content">
                        <span class="stat-hero-label">Nomor</span>
                        <span class="stat-hero-value" id="userPhone">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions with Liquid Glass -->
        <div class="quick-actions-section">
            <h2 class="section-title-glass">
                <span class="title-icon-glow">‚ö°</span>
                Quick Actions
            </h2>
            <div class="quick-actions-liquid">
                <div class="action-card-liquid frosted-card" onclick="window.location.href='/products'">
                    <div class="action-liquid-bg"></div>
                    <div class="action-card-content">
                        <div class="action-icon-large">üõçÔ∏è</div>
                        <h3>Beli Produk</h3>
                        <p>Browse & shop produk digital premium</p>
                        <div class="action-badge">New</div>
                    </div>
                </div>

                <div class="action-card-liquid frosted-card" onclick="loadTransactions()">
                    <div class="action-liquid-bg"></div>
                    <div class="action-card-content">
                        <div class="action-icon-large">üìä</div>
                        <h3>Riwayat Transaksi</h3>
                        <p>Lihat detail pembelian & invoice</p>
                        <div class="action-badge">Hot</div>
                    </div>
                </div>

                <div class="action-card-liquid frosted-card" onclick="toggleAuditLogs()">
                    <div class="action-liquid-bg"></div>
                    <div class="action-card-content">
                        <div class="action-icon-large">üìã</div>
                        <h3>Audit Logs</h3>
                        <p>Monitor aktivitas & perubahan sistem</p>
                        <div class="action-badge admin-only">Admin</div>
                    </div>
                </div>

                <div class="action-card-liquid frosted-card" onclick="window.location.href='/settings'">
                    <div class="action-liquid-bg"></div>
                    <div class="action-card-content">
                        <div class="action-icon-large">‚öôÔ∏è</div>
                        <h3>Settings</h3>
                        <p>Konfigurasi & keamanan akun</p>
                        <div class="action-badge">Pro</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Activity Section (All Users) -->
        <div id="personalActivitySection" class="personal-activity-section">
            <h2 class="section-title-glass">
                <span class="title-icon-glow">üìà</span>
                Aktivitas Saya
            </h2>
            <div class="personal-stats-grid">
                <div class="personal-stat-card frosted-card">
                    <div class="personal-stat-icon">üí∏</div>
                    <div class="personal-stat-content">
                        <span class="personal-stat-label">Total Pembelian</span>
                        <span class="personal-stat-value" id="userTotalSpent">Rp 0</span>
                        <span class="personal-stat-change positive" id="userSpentChange">+0%</span>
                    </div>
                </div>
                <div class="personal-stat-card frosted-card">
                    <div class="personal-stat-icon">üõí</div>
                    <div class="personal-stat-content">
                        <span class="personal-stat-label">Total Transaksi</span>
                        <span class="personal-stat-value" id="userTotalTransactions">0</span>
                        <span class="personal-stat-change" id="userTransactionsChange">Bulan ini</span>
                    </div>
                </div>
                <div class="personal-stat-card frosted-card">
                    <div class="personal-stat-icon">‚≠ê</div>
                    <div class="personal-stat-content">
                        <span class="personal-stat-label">Produk Favorit</span>
                        <span class="personal-stat-value" id="userFavoriteProduct">-</span>
                        <span class="personal-stat-change" id="userFavoriteCount">0x dibeli</span>
                    </div>
                </div>
                <div class="personal-stat-card frosted-card">
                    <div class="personal-stat-icon">üéØ</div>
                    <div class="personal-stat-content">
                        <span class="personal-stat-label">Transaksi Terakhir</span>
                        <span class="personal-stat-value" id="userLastTransaction">-</span>
                        <span class="personal-stat-change" id="userLastTransactionTime">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Logs Section (Admin Only) -->
        <div id="auditLogsSection" class="audit-logs-section" style="display: none;">
            <div class="section-header-liquid">
                <h2 class="section-title-glass">
                    <span class="title-icon-glow">üìã</span>
                    Audit Logs
                </h2>
                <button class="btn-close-liquid" onclick="toggleAuditLogs()">‚úï</button>
            </div>
            
            <div class="audit-controls frosted-card">
                <div class="audit-filters">
                    <select id="auditTypeFilter" onchange="filterAuditLogs()" class="select-liquid">
                        <option value="all">All Actions</option>
                        <option value="saldo">Saldo Changes</option>
                        <option value="stock">Stock Changes</option>
                        <option value="transaction">Transactions</option>
                        <option value="auth">Authentication</option>
                    </select>
                    <select id="auditUserFilter" onchange="filterAuditLogs()" class="select-liquid">
                        <option value="all">All Users</option>
                    </select>
                    <button class="btn-refresh-liquid" onclick="loadAuditLogs()">
                        <span>üîÑ</span> Refresh
                    </button>
                </div>
                <div class="audit-summary" id="auditSummary">Loading logs...</div>
            </div>

            <div id="auditLogsList" class="audit-logs-list">
                <div class="loading-state-liquid">
                    <div class="loader-aurora"></div>
                    <p>Loading audit logs...</p>
                </div>
            </div>
        </div>

        <!-- Transaction History Section -->
        <div id="transactionSection" class="transaction-section-modern" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="title-icon">üìú</span>
                    Riwayat Transaksi
                </h2>
                <button class="btn-close-section" onclick="closeTransactions()">‚úï</button>
            </div>
            
            <!-- Transaction Filters -->
            <div class="transaction-filters frosted-card">
                <div class="filter-group">
                    <div class="search-box-transaction">
                        <span class="search-icon-transaction">üîç</span>
                        <input type="text" id="transactionSearch" placeholder="Cari transaksi..." onkeyup="filterTransactions()">
                    </div>
                    <select id="statusFilter" onchange="filterTransactions()" class="select-filter">
                        <option value="all">Semua Status</option>
                        <option value="success">Sukses</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Gagal</option>
                    </select>
                    <select id="dateFilter" onchange="filterTransactions()" class="select-filter">
                        <option value="all">Semua Waktu</option>
                        <option value="today">Hari Ini</option>
                        <option value="week">7 Hari Terakhir</option>
                        <option value="month">30 Hari Terakhir</option>
                        <option value="3months">3 Bulan Terakhir</option>
                    </select>
                    <button class="btn-reset-filter" onclick="resetTransactionFilters()">
                        <span>üîÑ</span> Reset
                    </button>
                </div>
                <div class="filter-summary" id="filterSummary"></div>
            </div>
            
            <div id="transactionList" class="transaction-list-modern"></div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content transaction-modal-content">
            <div class="modal-header">
                <h2>Detail Transaksi</h2>
                <div class="modal-header-actions">
                    <button class="btn-copy btn-copy-header" onclick="copyReceiptToClipboard()">
                        üìã Copy Receipt
                    </button>
                    <span class="modal-close" onclick="closeTransactionModal()">&times;</span>
                </div>
            </div>
            
            <div class="modal-body">
                <div id="transactionDetail" class="transaction-detail"></div>
                <div id="accountDetailsSection" class="account-details-section"></div>
                <div id="snkSection" class="snk-section"></div>
            </div>
            
            <div class="modal-actions-bottom">
                <button class="btn-secondary" onclick="closeTransactionModal()">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variable to store current receipt content
        let currentReceiptContent = null;
        let currentReffId = null;

        let allTransactions = [];
        let isAdmin = false;
        let currentUser = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    window.location.href = '/';
                    return;
                }

                currentUser = data.user;

                // Update UI with user data
                document.getElementById('userBalance').textContent = formatRupiah(data.user.saldo || 0);
                document.getElementById('userRole').textContent = (data.user.role || 'bronze').toUpperCase();
                document.getElementById('userPhone').textContent = formatPhone(data.user.phone);

                isAdmin = data.user.isAdmin;

                // Show Admin features if user is admin
                if (isAdmin) {
                    const adminLink = document.querySelector('a[href="/admin"]');
                    if (adminLink) adminLink.classList.add('show-admin');
                } else {
                    // Hide admin-only action card
                    document.querySelectorAll('.admin-only').forEach(el => {
                        const card = el.closest('.action-card-liquid');
                        if (card) card.style.display = 'none';
                    });
                }

                // Load user's own transaction summary
                loadUserSummary();
            } catch (error) {
                console.error('Auth check failed:', error);
                // Don't redirect immediately, show error
                showToast('Failed to load user data', 'error');
            }
        }

        // Load User's Own Summary
        async function loadUserSummary() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                if (data.success && data.transactions && data.transactions.length > 0) {
                    const transactions = data.transactions;
                    
                    // Calculate total spent
                    const totalSpent = transactions.reduce((sum, t) => sum + (t.totalPrice || t.amount || 0), 0);
                    
                    // Count transactions this month
                    const now = new Date();
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const thisMonthTransactions = transactions.filter(t => {
                        const transDate = new Date(t.createdAt || t.date);
                        return transDate >= thisMonthStart;
                    });
                    
                    // Find favorite product (most purchased)
                    const productCount = {};
                    transactions.forEach(t => {
                        const productName = t.productName || t.product?.name || 'Unknown';
                        productCount[productName] = (productCount[productName] || 0) + 1;
                    });
                    
                    let favoriteProduct = '-';
                    let maxCount = 0;
                    Object.entries(productCount).forEach(([product, count]) => {
                        if (count > maxCount) {
                            maxCount = count;
                            favoriteProduct = product;
                        }
                    });
                    
                    // Get last transaction
                    const lastTrans = transactions[0]; // Assuming sorted by date desc
                    const lastTransDate = lastTrans ? new Date(lastTrans.createdAt || lastTrans.date) : null;
                    const lastTransTime = lastTransDate ? getTimeAgo(lastTransDate) : '-';
                    
                    // Update UI
                    document.getElementById('userTotalSpent').textContent = formatRupiah(totalSpent);
                    document.getElementById('userTotalTransactions').textContent = transactions.length;
                    document.getElementById('userTransactionsChange').textContent = `${thisMonthTransactions.length} bulan ini`;
                    document.getElementById('userFavoriteProduct').textContent = favoriteProduct.length > 20 ? 
                        favoriteProduct.substring(0, 17) + '...' : favoriteProduct;
                    document.getElementById('userFavoriteCount').textContent = maxCount > 0 ? `${maxCount}x dibeli` : 'Belum ada';
                    document.getElementById('userLastTransaction').textContent = lastTrans?.productName || '-';
                    document.getElementById('userLastTransactionTime').textContent = lastTransTime;
                    
                    // Calculate spending change (compare with previous month)
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = thisMonthStart;
                    const lastMonthSpent = transactions.filter(t => {
                        const transDate = new Date(t.createdAt || t.date);
                        return transDate >= lastMonthStart && transDate < lastMonthEnd;
                    }).reduce((sum, t) => sum + (t.totalPrice || t.amount || 0), 0);
                    
                    const thisMonthSpent = thisMonthTransactions.reduce((sum, t) => 
                        sum + (t.totalPrice || t.amount || 0), 0);
                    
                    const changePercent = lastMonthSpent > 0 ? 
                        Math.round(((thisMonthSpent - lastMonthSpent) / lastMonthSpent) * 100) : 0;
                    
                    const changeEl = document.getElementById('userSpentChange');
                    if (changePercent > 0) {
                        changeEl.textContent = `+${changePercent}%`;
                        changeEl.className = 'personal-stat-change positive';
                    } else if (changePercent < 0) {
                        changeEl.textContent = `${changePercent}%`;
                        changeEl.className = 'personal-stat-change negative';
                    } else {
                        changeEl.textContent = '0%';
                        changeEl.className = 'personal-stat-change';
                    }
                    
                    console.log('User Summary loaded:', {
                        totalSpent,
                        transactions: transactions.length,
                        thisMonth: thisMonthTransactions.length,
                        favorite: favoriteProduct
                    });
                } else {
                    // No transactions yet
                    document.getElementById('userTotalSpent').textContent = 'Rp 0';
                    document.getElementById('userTotalTransactions').textContent = '0';
                    document.getElementById('userTransactionsChange').textContent = 'Belum ada';
                    document.getElementById('userFavoriteProduct').textContent = 'Belum ada';
                    document.getElementById('userFavoriteCount').textContent = 'Belum ada';
                    document.getElementById('userLastTransaction').textContent = 'Belum ada';
                    document.getElementById('userLastTransactionTime').textContent = 'Belum ada transaksi';
                }
            } catch (error) {
                console.error('Failed to load user summary:', error);
                showToast('Gagal memuat aktivitas', 'error');
            }
        }
        
        // Helper: Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} hari lalu`;
            if (hours > 0) return `${hours} jam lalu`;
            if (minutes > 0) return `${minutes} menit lalu`;
            return 'Baru saja';
        }

        // Audit Logs Management
        let allAuditLogs = [];

        function toggleAuditLogs() {
            if (!isAdmin) {
                showToast('Access denied. Admin only.', 'error');
                return;
            }
            const section = document.getElementById('auditLogsSection');
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                loadAuditLogs();
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadAuditLogs() {
            if (!isAdmin) return;
            
            try {
                // Since audit log API might not exist yet, we'll simulate with transaction history
                const response = await fetch('/api/transactions/all').catch(() => ({ ok: false }));
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.transactions) {
                        // Transform transactions into audit log format
                        allAuditLogs = data.transactions.map(t => ({
                            id: t.refId,
                            type: 'transaction',
                            action: `Transaksi ${t.productName}`,
                            user: t.userId || 'Unknown',
                            amount: t.totalPrice,
                            timestamp: new Date(t.createdAt || t.date),
                            details: `${t.quantity}x ${t.productName} - ${t.metode}`
                        }));
                        
                        // Sort by timestamp desc
                        allAuditLogs.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Populate user filter
                        const uniqueUsers = [...new Set(allAuditLogs.map(log => log.user))];
                        const userFilter = document.getElementById('auditUserFilter');
                        userFilter.innerHTML = '<option value="all">All Users</option>' + 
                            uniqueUsers.map(user => `<option value="${user}">${formatPhone(user)}</option>`).join('');
                        
                        displayAuditLogs(allAuditLogs);
                        document.getElementById('auditSummary').textContent = 
                            `Showing ${allAuditLogs.length} audit entries`;
                    } else {
                        // No data
                        allAuditLogs = [];
                        displayAuditLogs([]);
                    }
                } else {
                    // API not available, show placeholder
                    document.getElementById('auditLogsList').innerHTML = `
                        <div class="empty-state-modern">
                            <div class="empty-icon">üìã</div>
                            <h3>Audit API Not Available</h3>
                            <p>Audit logging feature is coming soon</p>
                        </div>`;
                }
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                showToast('Failed to load audit logs', 'error');
            }
        }

        function displayAuditLogs(logs) {
            const container = document.getElementById('auditLogsList');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-modern">
                        <div class="empty-icon">üìã</div>
                        <h3>No audit logs</h3>
                        <p>No activity logs match your filters</p>
                    </div>`;
                return;
            }

            container.innerHTML = logs.map((log, index) => `
                <div class="audit-log-item frosted-card" style="animation-delay: ${index * 0.03}s">
                    <div class="audit-log-icon ${log.type}">
                        ${log.type === 'transaction' ? 'üõí' : 
                          log.type === 'saldo' ? 'üí∞' : 
                          log.type === 'stock' ? 'üì¶' : 'üîê'}
                    </div>
                    <div class="audit-log-content">
                        <div class="audit-log-header">
                            <h4 class="audit-log-action">${log.action}</h4>
                            <span class="audit-log-time">${getTimeAgo(log.timestamp)}</span>
                        </div>
                        <p class="audit-log-details">${log.details}</p>
                        <div class="audit-log-meta">
                            <span class="audit-meta-item">
                                <span class="audit-meta-label">User:</span>
                                <span class="audit-meta-value">${formatPhone(log.user)}</span>
                            </span>
                            ${log.amount ? `
                                <span class="audit-meta-item">
                                    <span class="audit-meta-label">Amount:</span>
                                    <span class="audit-meta-value">${formatRupiah(log.amount)}</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterAuditLogs() {
            const typeFilter = document.getElementById('auditTypeFilter').value;
            const userFilter = document.getElementById('auditUserFilter').value;

            let filtered = allAuditLogs;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(log => log.type === typeFilter);
            }

            if (userFilter !== 'all') {
                filtered = filtered.filter(log => log.user === userFilter);
            }

            displayAuditLogs(filtered);
            document.getElementById('auditSummary').textContent = 
                filtered.length === allAuditLogs.length ? 
                `Showing ${filtered.length} audit entries` :
                `Showing ${filtered.length} of ${allAuditLogs.length} audit entries`;
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                if (!data.success) {
                    showToast('Gagal memuat riwayat transaksi', 'error');
                    return;
                }

                allTransactions = data.transactions || [];
                displayTransactions(allTransactions);

                const transactionSection = document.getElementById('transactionSection');
                transactionSection.style.display = 'block';
                transactionSection.scrollIntoView({ behavior: 'smooth' });
                
                // Update filter summary
                updateFilterSummary(allTransactions.length, allTransactions.length);
            } catch (error) {
                console.error('Load transactions failed:', error);
                showToast('Gagal memuat riwayat transaksi', 'error');
            }
        }

        // Display Transactions
        function displayTransactions(transactions) {
            const transactionList = document.getElementById('transactionList');

            if (transactions.length === 0) {
                transactionList.innerHTML = `
                    <div class="empty-state-modern">
                        <div class="empty-icon">üì≠</div>
                        <h3>Tidak ada transaksi</h3>
                        <p>Tidak ada transaksi yang cocok dengan filter</p>
                    </div>`;
                return;
            }

            transactionList.innerHTML = transactions.map((t, index) => {
                // Determine status badge (normalize status values)
                let status = (t.status || 'completed').toLowerCase();
                // Map 'completed' to 'success' for display
                if (status === 'completed' || status === 'success') {
                    status = 'success';
                } else if (status === 'pending' || status === 'waiting') {
                    status = 'pending';
                } else if (status === 'failed' || status === 'gagal' || status === 'error') {
                    status = 'failed';
                } else {
                    // Default to success if status is unknown but transaction exists
                    status = 'success';
                }
                const statusBadge = status === 'success' ? '‚úì Success' : 
                                    status === 'pending' ? '‚è≥ Pending' : '‚úó Failed';
                
                return `
                    <div class="transaction-card-modern" style="animation-delay: ${index * 0.05}s">
                        <div class="transaction-card-header">
                            <div class="transaction-icon">üõí</div>
                            <div class="transaction-badge ${status}">${statusBadge}</div>
                        </div>
                        <div class="transaction-card-body">
                            <h4 class="transaction-title">${t.productName}</h4>
                            <div class="transaction-details">
                                <span class="detail-item">
                                    <span class="detail-label">Ref ID:</span>
                                    <span class="detail-value">${t.refId}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">Qty:</span>
                                    <span class="detail-value">${t.quantity}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">üìÖ</span>
                                    <span class="detail-value">${t.date}</span>
                                </span>
                            </div>
                        </div>
                        <div class="transaction-card-footer">
                            <div class="transaction-price">${formatRupiah(t.totalPrice)}</div>
                            <button class="btn-view-detail" onclick="viewTransactionDetail('${t.refId}')">
                                Lihat Detail ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter Transactions
        function filterTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filtered = allTransactions;

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(t =>
                    t.productName.toLowerCase().includes(searchTerm) ||
                    t.refId.toLowerCase().includes(searchTerm) ||
                    (t.metode && t.metode.toLowerCase().includes(searchTerm))
                );
            }

            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => {
                    let status = (t.status || 'completed').toLowerCase();
                    // Normalize status for filtering
                    if (status === 'completed' || status === 'success') {
                        status = 'success';
                    } else if (status === 'pending' || status === 'waiting') {
                        status = 'pending';
                    } else if (status === 'failed' || status === 'gagal' || status === 'error') {
                        status = 'failed';
                    } else {
                        status = 'success';
                    }
                    return status === statusFilter;
                });
            }

            // Apply date filter
            if (dateFilter !== 'all') {
                const now = new Date();
                filtered = filtered.filter(t => {
                    const transDate = new Date(t.createdAt || t.date);
                    const diffTime = now - transDate;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);

                    switch (dateFilter) {
                        case 'today':
                            return diffDays < 1;
                        case 'week':
                            return diffDays < 7;
                        case 'month':
                            return diffDays < 30;
                        case '3months':
                            return diffDays < 90;
                        default:
                            return true;
                    }
                });
            }

            displayTransactions(filtered);
            updateFilterSummary(filtered.length, allTransactions.length);
        }

        // Reset Transaction Filters
        function resetTransactionFilters() {
            document.getElementById('transactionSearch').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('dateFilter').value = 'all';
            displayTransactions(allTransactions);
            updateFilterSummary(allTransactions.length, allTransactions.length);
        }

        // Update Filter Summary
        function updateFilterSummary(shown, total) {
            const summary = document.getElementById('filterSummary');
            if (shown === total) {
                summary.textContent = `Menampilkan ${total} transaksi`;
            } else {
                summary.textContent = `Menampilkan ${shown} dari ${total} transaksi`;
            }
        }

        function closeTransactions() {
            document.getElementById('transactionSection').style.display = 'none';
        }

        async function viewTransactionDetail(reffId) {
            try {
                const response = await fetch(`/api/transactions/${reffId}`);
                const data = await response.json();

                if (!data.success) {
                    alert('Gagal memuat detail transaksi');
                    return;
                }

                const transaction = data.transaction;
                const accountDetails = data.accountDetails;
                
                // Store receipt content and reffId globally
                currentReceiptContent = data.receiptContent;
                currentReffId = reffId;

                // Parse tanggal dan jam
                const dateTime = transaction.date ? transaction.date.split(' ') : ['', ''];
                const tanggal = dateTime[0] || 'N/A';
                const jam = dateTime[1] || 'N/A';

                // Build account info header (seperti di bot WA)
                let detailHTML = '<div class="account-info-header">';
                detailHTML += `<h3>Account Information</h3>`;
                detailHTML += `<div class="info-item">üì¶ <strong>Produk:‚òÖ</strong> ${transaction.productName}</div>`;
                detailHTML += `<div class="info-item">üìÖ <strong>Tanggal:‚òÖ</strong> ${tanggal}</div>`;
                detailHTML += `<div class="info-item">‚è±Ô∏è <strong>Jam:‚òÖ</strong> ${jam} WIB</div>`;
                detailHTML += `<div class="info-item">üÜî <strong>Refid:‚òÖ</strong> ${transaction.refId}</div>`;
                detailHTML += `</div>`;

                document.getElementById('transactionDetail').innerHTML = detailHTML;

                // Build account details (format seperti bot WA)
                let accountHTML = '';
                if (accountDetails && accountDetails.length > 0) {
                    accountHTML = '<div class="account-details-list">';
                    accountDetails.forEach((account, index) => {
                        if (index > 0) accountHTML += '<hr class="account-divider">';
                        accountHTML += `
                            <div class="account-detail-item">
                                <div class="detail-line"><span class="detail-icon">üìß</span><span class="detail-label">Email:</span><span class="detail-value">${account.email}</span></div>
                                <div class="detail-line"><span class="detail-icon">üîê</span><span class="detail-label">Password:</span><span class="detail-value">${account.password}</span></div>
                                <div class="detail-line"><span class="detail-icon">üë§</span><span class="detail-label">Profil:</span><span class="detail-value">${account.profile}</span></div>
                                <div class="detail-line"><span class="detail-icon">üî¢</span><span class="detail-label">Pin:</span><span class="detail-value">${account.pin}</span></div>
                                <div class="detail-line"><span class="detail-icon">üîí</span><span class="detail-label">2FA:</span><span class="detail-value">${account.twofa}</span></div>
                            </div>
                        `;
                    });
                    accountHTML += '</div>';
                    
                    // Tambah info pembayaran di bawah
                    accountHTML += `<div class="payment-info">`;
                    accountHTML += `<div class="payment-row"><span>üí∞ <strong>Metode:</strong></span> <span>${transaction.metode}</span></div>`;
                    accountHTML += `<div class="payment-row"><span>üíµ <strong>Total:</strong></span> <span>${formatRupiah(transaction.totalPrice)}</span></div>`;
                    accountHTML += `</div>`;
                } else {
                    accountHTML = '<p class="empty-state">Detail akun tidak tersedia</p>';
                }

                document.getElementById('accountDetailsSection').innerHTML = accountHTML;
                
                // Parse and display SNK from receipt content
                let snkHTML = '';
                if (currentReceiptContent) {
                    const lines = currentReceiptContent.split('\n');
                    let inSnkSection = false;
                    let snkLines = [];
                    let snkTitle = '';
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.includes('SNK PRODUK:') || line.includes('üìã SNK PRODUK:')) {
                            inSnkSection = true;
                            snkTitle = line.replace(/[*üìã]/g, '').replace('SNK PRODUK:', '').trim();
                            continue;
                        }
                        if (line.includes('END SNK') || line.includes('‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ')) {
                            inSnkSection = false;
                            break;
                        }
                        if (inSnkSection && line && !line.includes('SYARAT & KETENTUAN') && !line.includes('‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ')) {
                            snkLines.push(line.replace(/[*]/g, ''));
                        }
                    }
                    
                    if (snkLines.length > 0) {
                        snkHTML = '<div class="snk-container">';
                        snkHTML += `<h3 class="snk-title">üìã SNK PRODUK: ${snkTitle || transaction.productName}</h3>`;
                        snkHTML += '<div class="snk-content">';
                        snkLines.forEach(line => {
                            if (line.trim()) {
                                // Format line dengan emoji dan styling
                                let formattedLine = line;
                                if (line.includes('‚úÖ')) {
                                    formattedLine = `<div class="snk-item snk-allowed">${line}</div>`;
                                } else if (line.includes('üö´') || line.includes('dilarang')) {
                                    formattedLine = `<div class="snk-item snk-prohibited">${line}</div>`;
                                } else if (line.startsWith('*') || line.match(/^[‚Ä¢\-\*]/)) {
                                    formattedLine = `<div class="snk-item">${line.replace(/^[‚Ä¢\-\*]\s*/, '')}</div>`;
                                } else {
                                    formattedLine = `<div class="snk-item">${line}</div>`;
                                }
                                snkHTML += formattedLine;
                            }
                        });
                        snkHTML += '</div></div>';
                    }
                }
                
                document.getElementById('snkSection').innerHTML = snkHTML;
                document.getElementById('transactionModal').style.display = 'flex';
            } catch (error) {
                console.error('View transaction detail failed:', error);
                alert('Gagal memuat detail transaksi');
            }
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').style.display = 'none';
            currentReceiptContent = null;
            currentReffId = null;
        }

        async function copyReceiptToClipboard() {
            try {
                if (!currentReceiptContent) {
                    showToast('Receipt tidak tersedia', 'error');
                    return;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(currentReceiptContent);
                showToast('‚úÖ Receipt berhasil dicopy!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                
                // Fallback method for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentReceiptContent;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('‚úÖ Receipt berhasil dicopy!', 'success');
                } catch (fallbackError) {
                    showToast('‚ùå Gagal copy receipt', 'error');
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatPhone(phone) {
            if (!phone) return '-';
            if (phone.startsWith('62')) {
                return '0' + phone.substring(2);
            }
            return phone;
        }

        // Mobile menu toggle
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuIcon = document.getElementById('menuIcon');
            navLinks.classList.toggle('active');
            menuIcon.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const navToggle = document.querySelector('.nav-toggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks.classList.contains('active') && 
                !navbar.contains(event.target)) {
                toggleMenu();
            }
        });

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>

