<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dashboard - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">ğŸ¤– GiHa Smart Bot</div>
        
        <!-- User Balance in Navbar -->
        <div class="navbar-balance">
            <span class="balance-label">Saldo:</span>
            <span class="balance-value" id="navbarBalance">Rp 0</span>
        </div>
        
        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle menu">
            <span id="menuIcon">â˜°</span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard" class="active">Dashboard</a>
            <a href="/products">Produk</a>
            <a href="/admin">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Simple Header -->
        <div class="dashboard-header">
            <h1>Dashboard</h1>
            <p>Selamat datang! Kelola aktivitas dan transaksi Anda di sini</p>
        </div>

        <!-- Running Text Promo -->
        <div class="running-text-container">
            <div class="running-text">
                <span>ğŸ‰ Promo Deposit 50.000 Bonus 5.000 ğŸ‰</span>
                <span>ğŸ‰ Promo Deposit 50.000 Bonus 5.000 ğŸ‰</span>
                <span>ğŸ‰ Promo Deposit 50.000 Bonus 5.000 ğŸ‰</span>
            </div>
        </div>

        <!-- User Stats - Simple Cards -->
        <div class="stats-grid-simple">
            <div class="stat-card-simple">
                <div class="stat-icon">ğŸ‘¤</div>
                <div class="stat-info">
                    <span class="stat-label">Status Akun</span>
                    <span class="stat-value" id="userRole">-</span>
                </div>
            </div>
            <div class="stat-card-simple">
                <div class="stat-icon">ğŸ“±</div>
                <div class="stat-info">
                    <span class="stat-label">Nomor Telepon</span>
                    <span class="stat-value" id="userPhone">-</span>
                </div>
            </div>
            <div class="stat-card-simple">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-info">
                    <span class="stat-label">Total Transaksi</span>
                    <span class="stat-value" id="userTotalTransactions">0</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions - Simple Grid -->
        <div class="section-simple">
            <h2 class="section-title-simple">âš¡ Akses Cepat</h2>
            <div class="actions-grid-simple">
                <button class="action-btn-simple" onclick="window.location.href='/products'">
                    <span class="action-icon">ğŸ›ï¸</span>
                    <span class="action-text">Beli Produk</span>
                </button>
                <button class="action-btn-simple" onclick="loadTransactions()">
                    <span class="action-icon">ğŸ“Š</span>
                    <span class="action-text">Riwayat Transaksi</span>
                </button>
                <button class="action-btn-simple admin-only" onclick="toggleAuditLogs()" style="display: none;">
                    <span class="action-icon">ğŸ“‹</span>
                    <span class="action-text">Log Aktivitas</span>
                </button>
                <button class="action-btn-simple" onclick="window.location.href='/settings'">
                    <span class="action-icon">âš™ï¸</span>
                    <span class="action-text">Pengaturan</span>
                </button>
            </div>
        </div>

        <!-- Personal Activity - Simple Cards -->
        <div id="personalActivitySection" class="section-simple">
            <h2 class="section-title-simple">ğŸ“ˆ Ringkasan Aktivitas</h2>
            <div class="activity-grid-simple">
                <div class="activity-card-simple">
                    <div class="activity-icon">ğŸ’¸</div>
                    <div class="activity-content">
                        <span class="activity-label">Total Pengeluaran</span>
                        <span class="activity-value" id="userTotalSpent">Rp 0</span>
                        <span class="activity-change positive" id="userSpentChange">+0%</span>
                    </div>
                </div>
                <div class="activity-card-simple">
                    <div class="activity-icon">ğŸ›’</div>
                    <div class="activity-content">
                        <span class="activity-label">Jumlah Transaksi</span>
                        <span class="activity-value" id="userTotalTransactions">0</span>
                        <span class="activity-change" id="userTransactionsChange">Bulan ini</span>
                    </div>
                </div>
                <div class="activity-card-simple">
                    <div class="activity-icon">â­</div>
                    <div class="activity-content">
                        <span class="activity-label">Produk Favorit</span>
                        <span class="activity-value" id="userFavoriteProduct">-</span>
                        <span class="activity-change" id="userFavoriteCount">0x dibeli</span>
                    </div>
                </div>
                <div class="activity-card-simple">
                    <div class="activity-icon">ğŸ¯</div>
                    <div class="activity-content">
                        <span class="activity-label">Transaksi Terakhir</span>
                        <span class="activity-value" id="userLastTransaction">-</span>
                        <span class="activity-change" id="userLastTransactionTime">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Logs Section (Admin Only) -->
        <div id="auditLogsSection" class="section-simple" style="display: none;">
            <div class="section-header-simple">
                <h2 class="section-title-simple">ğŸ“‹ Log Aktivitas Sistem</h2>
                <button class="btn-close-simple" onclick="toggleAuditLogs()">âœ•</button>
            </div>
            
            <div class="filters-simple">
                <select id="auditTypeFilter" onchange="filterAuditLogs()" class="select-simple">
                    <option value="all">Semua Aktivitas</option>
                    <option value="saldo">Perubahan Saldo</option>
                    <option value="stock">Perubahan Stok</option>
                    <option value="transaction">Transaksi</option>
                    <option value="auth">Autentikasi</option>
                </select>
                <select id="auditUserFilter" onchange="filterAuditLogs()" class="select-simple">
                    <option value="all">Semua Pengguna</option>
                </select>
                <button class="btn-simple" onclick="loadAuditLogs()">ğŸ”„ Muat Ulang</button>
            </div>
            <div class="summary-text" id="auditSummary">Memuat log aktivitas...</div>

            <div id="auditLogsList" class="logs-list-simple"></div>
        </div>

        <!-- Transaction History Section -->
        <div id="transactionSection" class="section-simple" style="display: none;">
            <div class="section-header-simple">
                <h2 class="section-title-simple">ğŸ“œ Riwayat Transaksi</h2>
                <button class="btn-close-simple" onclick="closeTransactions()">âœ•</button>
            </div>
            
            <div class="filters-simple">
                <input type="text" id="transactionSearch" placeholder="ğŸ” Cari transaksi..." class="input-simple" onkeyup="filterTransactions()">
                <select id="statusFilter" onchange="filterTransactions()" class="select-simple">
                    <option value="all">Semua Status</option>
                    <option value="success">Berhasil</option>
                    <option value="pending">Menunggu</option>
                    <option value="failed">Gagal</option>
                </select>
                <select id="dateFilter" onchange="filterTransactions()" class="select-simple">
                    <option value="all">Semua Waktu</option>
                    <option value="today">Hari Ini</option>
                    <option value="week">7 Hari Terakhir</option>
                    <option value="month">30 Hari Terakhir</option>
                    <option value="3months">3 Bulan Terakhir</option>
                </select>
                <button class="btn-simple" onclick="resetTransactionFilters()">ğŸ”„ Reset Filter</button>
            </div>
            <div class="summary-text" id="filterSummary"></div>
            
            <div id="transactionList" class="transaction-list-simple"></div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content transaction-modal-content">
            <div class="modal-header">
                <h2>Detail Transaksi</h2>
                <div class="modal-header-actions">
                    <button class="btn-copy btn-copy-header" onclick="copyReceiptToClipboard()">
                        ğŸ“‹ Copy Receipt
                    </button>
                    <span class="modal-close" onclick="closeTransactionModal()">&times;</span>
                </div>
            </div>
            
            <div class="modal-body">
                <div id="transactionDetail" class="transaction-detail"></div>
                <div id="accountDetailsSection" class="account-details-section"></div>
            </div>
            
            <div class="modal-actions-bottom">
                <button class="btn-secondary" onclick="closeTransactionModal()">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variable to store current receipt content
        let currentReceiptContent = null;
        let currentReffId = null;

        let allTransactions = [];
        let isAdmin = false;
        let currentUser = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    window.location.href = '/';
                    return;
                }

                currentUser = data.user;

                // Update UI with user data
                const navbarBalance = document.getElementById('navbarBalance');
                if (navbarBalance) {
                    navbarBalance.textContent = formatRupiah(data.user.saldo || 0);
                }
                document.getElementById('userRole').textContent = (data.user.role || 'bronze').toUpperCase();
                document.getElementById('userPhone').textContent = formatPhone(data.user.phone);

                isAdmin = data.user.isAdmin;

                // Show Admin features if user is admin
                if (isAdmin) {
                    const adminLink = document.querySelector('a[href="/admin"]');
                    if (adminLink) adminLink.classList.add('show-admin');
                    // Show admin-only action button
                    const adminBtn = document.querySelector('.action-btn-simple.admin-only');
                    if (adminBtn) adminBtn.style.display = 'flex';
                } else {
                    // Hide admin-only action button
                    const adminBtn = document.querySelector('.action-btn-simple.admin-only');
                    if (adminBtn) adminBtn.style.display = 'none';
                }

                // Load user's own transaction summary
                loadUserSummary();
            } catch (error) {
                console.error('Auth check failed:', error);
                // Don't redirect immediately, show error
                showToast('Failed to load user data', 'error');
            }
        }

        // Load User's Own Summary
        async function loadUserSummary() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                if (data.success && data.transactions && data.transactions.length > 0) {
                    const transactions = data.transactions;
                    
                    // Calculate total spent
                    const totalSpent = transactions.reduce((sum, t) => sum + (t.totalPrice || t.amount || 0), 0);
                    
                    // Count transactions this month
                    const now = new Date();
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const thisMonthTransactions = transactions.filter(t => {
                        const transDate = new Date(t.createdAt || t.date);
                        return transDate >= thisMonthStart;
                    });
                    
                    // Find favorite product (most purchased)
                    const productCount = {};
                    transactions.forEach(t => {
                        const productName = t.productName || t.product?.name || 'Unknown';
                        productCount[productName] = (productCount[productName] || 0) + 1;
                    });
                    
                    let favoriteProduct = '-';
                    let maxCount = 0;
                    Object.entries(productCount).forEach(([product, count]) => {
                        if (count > maxCount) {
                            maxCount = count;
                            favoriteProduct = product;
                        }
                    });
                    
                    // Get last transaction
                    const lastTrans = transactions[0]; // Assuming sorted by date desc
                    const lastTransDate = lastTrans ? new Date(lastTrans.createdAt || lastTrans.date) : null;
                    const lastTransTime = lastTransDate ? getTimeAgo(lastTransDate) : '-';
                    
                    // Update UI
                    document.getElementById('userTotalSpent').textContent = formatRupiah(totalSpent);
                    document.getElementById('userTotalTransactions').textContent = transactions.length;
                    document.getElementById('userTransactionsChange').textContent = `${thisMonthTransactions.length} bulan ini`;
                    document.getElementById('userFavoriteProduct').textContent = favoriteProduct.length > 20 ? 
                        favoriteProduct.substring(0, 17) + '...' : favoriteProduct;
                    document.getElementById('userFavoriteCount').textContent = maxCount > 0 ? `${maxCount}x dibeli` : 'Belum ada';
                    document.getElementById('userLastTransaction').textContent = lastTrans?.productName || '-';
                    document.getElementById('userLastTransactionTime').textContent = lastTransTime;
                    
                    // Calculate spending change (compare with previous month)
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = thisMonthStart;
                    const lastMonthSpent = transactions.filter(t => {
                        const transDate = new Date(t.createdAt || t.date);
                        return transDate >= lastMonthStart && transDate < lastMonthEnd;
                    }).reduce((sum, t) => sum + (t.totalPrice || t.amount || 0), 0);
                    
                    const thisMonthSpent = thisMonthTransactions.reduce((sum, t) => 
                        sum + (t.totalPrice || t.amount || 0), 0);
                    
                    const changePercent = lastMonthSpent > 0 ? 
                        Math.round(((thisMonthSpent - lastMonthSpent) / lastMonthSpent) * 100) : 0;
                    
                    const changeEl = document.getElementById('userSpentChange');
                    if (changePercent > 0) {
                        changeEl.textContent = `+${changePercent}%`;
                        changeEl.className = 'personal-stat-change positive';
                    } else if (changePercent < 0) {
                        changeEl.textContent = `${changePercent}%`;
                        changeEl.className = 'personal-stat-change negative';
                    } else {
                        changeEl.textContent = '0%';
                        changeEl.className = 'personal-stat-change';
                    }
                    
                    console.log('User Summary loaded:', {
                        totalSpent,
                        transactions: transactions.length,
                        thisMonth: thisMonthTransactions.length,
                        favorite: favoriteProduct
                    });
                } else {
                    // No transactions yet
                    document.getElementById('userTotalSpent').textContent = 'Rp 0';
                    document.getElementById('userTotalTransactions').textContent = '0';
                    document.getElementById('userTransactionsChange').textContent = 'Belum ada';
                    document.getElementById('userFavoriteProduct').textContent = 'Belum ada';
                    document.getElementById('userFavoriteCount').textContent = 'Belum ada';
                    document.getElementById('userLastTransaction').textContent = 'Belum ada';
                    document.getElementById('userLastTransactionTime').textContent = 'Belum ada transaksi';
                }
            } catch (error) {
                console.error('Failed to load user summary:', error);
                showToast('Gagal memuat aktivitas', 'error');
            }
        }
        
        // Helper: Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} hari lalu`;
            if (hours > 0) return `${hours} jam lalu`;
            if (minutes > 0) return `${minutes} menit lalu`;
            return 'Baru saja';
        }

        // Audit Logs Management
        let allAuditLogs = [];

        function toggleAuditLogs() {
            if (!isAdmin) {
                showToast('Access denied. Admin only.', 'error');
                return;
            }
            const section = document.getElementById('auditLogsSection');
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                loadAuditLogs();
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadAuditLogs() {
            if (!isAdmin) return;
            
            try {
                // Since audit log API might not exist yet, we'll simulate with transaction history
                const response = await fetch('/api/transactions/all').catch(() => ({ ok: false }));
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.transactions) {
                        // Transform transactions into audit log format
                        allAuditLogs = data.transactions.map(t => ({
                            id: t.refId,
                            type: 'transaction',
                            action: `Transaksi ${t.productName}`,
                            user: t.userId || 'Unknown',
                            amount: t.totalPrice,
                            timestamp: new Date(t.createdAt || t.date),
                            details: `${t.quantity}x ${t.productName} - ${t.metode}`
                        }));
                        
                        // Sort by timestamp desc
                        allAuditLogs.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Populate user filter
                        const uniqueUsers = [...new Set(allAuditLogs.map(log => log.user))];
                        const userFilter = document.getElementById('auditUserFilter');
                        userFilter.innerHTML = '<option value="all">Semua Pengguna</option>' + 
                            uniqueUsers.map(user => `<option value="${user}">${formatPhone(user)}</option>`).join('');
                        
                        displayAuditLogs(allAuditLogs);
                        document.getElementById('auditSummary').textContent = 
                            `Menampilkan ${allAuditLogs.length} log aktivitas`;
                    } else {
                        // No data
                        allAuditLogs = [];
                        displayAuditLogs([]);
                    }
                } else {
                    // API not available, show placeholder
                    document.getElementById('auditLogsList').innerHTML = `
                        <div class="empty-state-simple">
                            <div class="empty-icon-simple">ğŸ“‹</div>
                            <p>Audit API tidak tersedia</p>
                        </div>`;
                }
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                showToast('Gagal memuat log aktivitas', 'error');
            }
        }

        function displayAuditLogs(logs) {
            const container = document.getElementById('auditLogsList');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-simple">
                        <div class="empty-icon-simple">ğŸ“‹</div>
                        <p>Tidak ada audit logs</p>
                    </div>`;
                return;
            }

            container.innerHTML = logs.map((log) => `
                <div class="log-item-simple">
                    <div class="log-icon-simple">
                        ${log.type === 'transaction' ? 'ğŸ›’' : 
                          log.type === 'saldo' ? 'ğŸ’°' : 
                          log.type === 'stock' ? 'ğŸ“¦' : 'ğŸ”'}
                    </div>
                    <div class="log-content-simple">
                        <div class="log-header-simple">
                            <strong>${log.action}</strong>
                            <span class="log-time-simple">${getTimeAgo(log.timestamp)}</span>
                        </div>
                        <p class="log-details-simple">${log.details}</p>
                        <div class="log-meta-simple">
                            <span>User: ${formatPhone(log.user)}</span>
                            ${log.amount ? `<span>â€¢ ${formatRupiah(log.amount)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterAuditLogs() {
            const typeFilter = document.getElementById('auditTypeFilter').value;
            const userFilter = document.getElementById('auditUserFilter').value;

            let filtered = allAuditLogs;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(log => log.type === typeFilter);
            }

            if (userFilter !== 'all') {
                filtered = filtered.filter(log => log.user === userFilter);
            }

            displayAuditLogs(filtered);
            document.getElementById('auditSummary').textContent = 
                filtered.length === allAuditLogs.length ? 
                `Menampilkan ${filtered.length} log aktivitas` :
                `Menampilkan ${filtered.length} dari ${allAuditLogs.length} log aktivitas`;
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                if (!data.success) {
                    showToast('Gagal memuat riwayat transaksi', 'error');
                    return;
                }

                allTransactions = data.transactions || [];
                displayTransactions(allTransactions);

                const transactionSection = document.getElementById('transactionSection');
                transactionSection.style.display = 'block';
                transactionSection.scrollIntoView({ behavior: 'smooth' });
                
                // Update filter summary
                updateFilterSummary(allTransactions.length, allTransactions.length);
            } catch (error) {
                console.error('Load transactions failed:', error);
                showToast('Gagal memuat riwayat transaksi', 'error');
            }
        }

        // Display Transactions
        function displayTransactions(transactions) {
            const transactionList = document.getElementById('transactionList');

            if (transactions.length === 0) {
                transactionList.innerHTML = `
                    <div class="empty-state-simple">
                        <div class="empty-icon-simple">ğŸ“­</div>
                        <p>Tidak ada transaksi</p>
                    </div>`;
                return;
            }

            transactionList.innerHTML = transactions.map((t) => {
                // Determine status badge (normalize status values)
                let status = (t.status || 'completed').toLowerCase();
                if (status === 'completed' || status === 'success') {
                    status = 'success';
                } else if (status === 'pending' || status === 'waiting') {
                    status = 'pending';
                } else if (status === 'failed' || status === 'gagal' || status === 'error') {
                    status = 'failed';
                } else {
                    status = 'success';
                }
                const statusBadge = status === 'success' ? 'âœ“' : status === 'pending' ? 'â³' : 'âœ—';
                
                return `
                    <div class="transaction-card-simple">
                        <div class="transaction-header-simple">
                            <div class="transaction-icon-simple">ğŸ›’</div>
                            <div class="transaction-badge-simple ${status}">${statusBadge}</div>
                        </div>
                        <div class="transaction-body-simple">
                            <h4 class="transaction-title-simple">${t.productName}</h4>
                            <div class="transaction-details-simple">
                                <span>Ref: ${t.refId}</span>
                                <span>â€¢</span>
                                <span>Qty: ${t.quantity}</span>
                                <span>â€¢</span>
                                <span>${t.date}</span>
                            </div>
                        </div>
                        <div class="transaction-footer-simple">
                            <div class="transaction-price-simple">${formatRupiah(t.totalPrice)}</div>
                            <button class="btn-view-simple" onclick="viewTransactionDetail('${t.refId}')">
                                Detail â†’
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter Transactions
        function filterTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filtered = allTransactions;

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(t =>
                    t.productName.toLowerCase().includes(searchTerm) ||
                    t.refId.toLowerCase().includes(searchTerm) ||
                    (t.metode && t.metode.toLowerCase().includes(searchTerm))
                );
            }

            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => {
                    let status = (t.status || 'completed').toLowerCase();
                    // Normalize status for filtering
                    if (status === 'completed' || status === 'success') {
                        status = 'success';
                    } else if (status === 'pending' || status === 'waiting') {
                        status = 'pending';
                    } else if (status === 'failed' || status === 'gagal' || status === 'error') {
                        status = 'failed';
                    } else {
                        status = 'success';
                    }
                    return status === statusFilter;
                });
            }

            // Apply date filter
            if (dateFilter !== 'all') {
                const now = new Date();
                filtered = filtered.filter(t => {
                    const transDate = new Date(t.createdAt || t.date);
                    const diffTime = now - transDate;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);

                    switch (dateFilter) {
                        case 'today':
                            return diffDays < 1;
                        case 'week':
                            return diffDays < 7;
                        case 'month':
                            return diffDays < 30;
                        case '3months':
                            return diffDays < 90;
                        default:
                            return true;
                    }
                });
            }

            displayTransactions(filtered);
            updateFilterSummary(filtered.length, allTransactions.length);
        }

        // Reset Transaction Filters
        function resetTransactionFilters() {
            document.getElementById('transactionSearch').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('dateFilter').value = 'all';
            displayTransactions(allTransactions);
            updateFilterSummary(allTransactions.length, allTransactions.length);
        }

        // Update Filter Summary
        function updateFilterSummary(shown, total) {
            const summary = document.getElementById('filterSummary');
            if (shown === total) {
                summary.textContent = `Menampilkan ${total} transaksi`;
            } else {
                summary.textContent = `Menampilkan ${shown} dari ${total} transaksi`;
            }
        }

        function closeTransactions() {
            document.getElementById('transactionSection').style.display = 'none';
        }

        async function viewTransactionDetail(reffId) {
            try {
                const response = await fetch(`/api/transactions/${reffId}`);
                const data = await response.json();

                if (!data.success) {
                    alert('Gagal memuat detail transaksi');
                    return;
                }

                const transaction = data.transaction;
                const accountDetails = data.accountDetails;
                
                // Store receipt content and reffId globally
                currentReceiptContent = data.receiptContent;
                currentReffId = reffId;

                // Parse tanggal dan jam
                const dateTime = transaction.date ? transaction.date.split(' ') : ['', ''];
                const tanggal = dateTime[0] || 'N/A';
                const jam = dateTime[1] || 'N/A';

                // Build account info header (seperti di bot WA)
                let detailHTML = '<div class="account-info-header">';
                detailHTML += `<h3>Account Information</h3>`;
                detailHTML += `<div class="info-item">ğŸ“¦ <strong>Produk:â˜…</strong> ${transaction.productName}</div>`;
                detailHTML += `<div class="info-item">ğŸ“… <strong>Tanggal:â˜…</strong> ${tanggal}</div>`;
                detailHTML += `<div class="info-item">â±ï¸ <strong>Jam:â˜…</strong> ${jam} WIB</div>`;
                detailHTML += `<div class="info-item">ğŸ†” <strong>Refid:â˜…</strong> ${transaction.refId}</div>`;
                detailHTML += `</div>`;

                document.getElementById('transactionDetail').innerHTML = detailHTML;

                // Build account details (format seperti bot WA)
                let accountHTML = '';
                if (accountDetails && accountDetails.length > 0) {
                    accountHTML = '<div class="account-details-list">';
                    accountDetails.forEach((account, index) => {
                        if (index > 0) accountHTML += '<hr class="account-divider">';
                        accountHTML += `
                            <div class="account-detail-item">
                                <div class="detail-line"><span class="detail-icon">ğŸ“§</span><span class="detail-label">Email:</span><span class="detail-value">${account.email}</span></div>
                                <div class="detail-line"><span class="detail-icon">ğŸ”</span><span class="detail-label">Password:</span><span class="detail-value">${account.password}</span></div>
                                <div class="detail-line"><span class="detail-icon">ğŸ‘¤</span><span class="detail-label">Profil:</span><span class="detail-value">${account.profile}</span></div>
                                <div class="detail-line"><span class="detail-icon">ğŸ”¢</span><span class="detail-label">Pin:</span><span class="detail-value">${account.pin}</span></div>
                                <div class="detail-line"><span class="detail-icon">ğŸ”’</span><span class="detail-label">2FA:</span><span class="detail-value">${account.twofa}</span></div>
                            </div>
                        `;
                    });
                    accountHTML += '</div>';
                    
                    // Tambah info pembayaran di bawah
                    accountHTML += `<div class="payment-info">`;
                    accountHTML += `<div class="payment-row"><span>ğŸ’° <strong>Metode:</strong></span> <span>${transaction.metode}</span></div>`;
                    accountHTML += `<div class="payment-row"><span>ğŸ’µ <strong>Total:</strong></span> <span>${formatRupiah(transaction.totalPrice)}</span></div>`;
                    accountHTML += `</div>`;
                } else {
                    accountHTML = '<p class="empty-state">Detail akun tidak tersedia</p>';
                }

                document.getElementById('accountDetailsSection').innerHTML = accountHTML;
                
                document.getElementById('transactionModal').style.display = 'flex';
            } catch (error) {
                console.error('View transaction detail failed:', error);
                alert('Gagal memuat detail transaksi');
            }
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').style.display = 'none';
            currentReceiptContent = null;
            currentReffId = null;
        }

        async function copyReceiptToClipboard() {
            try {
                if (!currentReceiptContent) {
                    showToast('Receipt tidak tersedia', 'error');
                    return;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(currentReceiptContent);
                showToast('âœ… Receipt berhasil dicopy!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                
                // Fallback method for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentReceiptContent;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('âœ… Receipt berhasil dicopy!', 'success');
                } catch (fallbackError) {
                    showToast('âŒ Gagal copy receipt', 'error');
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatPhone(phone) {
            if (!phone) return '-';
            if (phone.startsWith('62')) {
                return '0' + phone.substring(2);
            }
            return phone;
        }

        // Mobile menu toggle
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuIcon = document.getElementById('menuIcon');
            navLinks.classList.toggle('active');
            menuIcon.textContent = navLinks.classList.contains('active') ? 'âœ•' : 'â˜°';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const navToggle = document.querySelector('.nav-toggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks.classList.contains('active') && 
                !navbar.contains(event.target)) {
                toggleMenu();
            }
        });

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>

