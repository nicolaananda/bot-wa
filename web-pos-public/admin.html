<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Admin Panel - GiHa Smart Bot POS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">ü§ñ GiHa Smart Bot</div>
        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle menu">
            <span id="menuIcon">‚ò∞</span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard">Dashboard</a>
            <a href="/products">Produk</a>
            <a href="/admin" class="active">Admin</a>
            <a href="/settings">Pengaturan</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div>
                <h1>üõ†Ô∏è Admin Panel</h1>
                <p>Kelola saldo user dan stok produk</p>
            </div>
        </div>

        <!-- Modern Tab Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchTab('saldo')">
                <span class="tab-icon">üí∞</span>
                <span class="tab-text">Kelola Saldo</span>
            </button>
            <button class="admin-tab" onclick="switchTab('stock')">
                <span class="tab-icon">üì¶</span>
                <span class="tab-text">Kelola Stok</span>
            </button>
            <button class="admin-tab" onclick="switchTab('products')">
                <span class="tab-icon">üìã</span>
                <span class="tab-text">Daftar Produk</span>
            </button>
        </div>

        <!-- Saldo Tab Content -->
        <div id="saldoTab" class="tab-content active">
            <div class="admin-card-single">
                <div class="card-header-icon">üí∞</div>
                <h2>Kelola Saldo User</h2>
                <p class="card-description">Tambah atau kurangi saldo untuk user tertentu</p>

                <div id="saldoAlertBox" class="alert"></div>

                <form id="addSaldoForm">
                    <div class="form-group">
                        <label for="userNumber">
                            <span class="label-icon">üì±</span>
                            Nomor User
                        </label>
                        <input 
                            type="text" 
                            id="userNumber" 
                            placeholder="Contoh: 628123456789 atau 08123456789"
                            required
                        >
                        <small class="form-hint">Nomor bisa diawali dengan 0, 62, atau +62</small>
                    </div>

                    <div class="form-group">
                        <label for="nominalSaldo">
                            <span class="label-icon">üíµ</span>
                            Nominal
                        </label>
                        <input 
                            type="number" 
                            id="nominalSaldo" 
                            placeholder="Contoh: 50000 (tambah) atau -20000 (kurang)"
                            step="1000"
                            required
                        >
                        <small class="form-hint">
                            <strong>Positif (+)</strong> = Tambah saldo &nbsp;|&nbsp;
                            <strong>Negatif (-)</strong> = Kurangi saldo
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="clearSaldoForm()">
                            <span class="btn-icon">üóëÔ∏è</span>
                            Clear
                        </button>
                        <button type="submit" class="btn-primary" id="btnSubmitSaldo">
                            <span class="btn-icon">‚úÖ</span>
                            Update Saldo
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stock Tab Content -->
        <div id="stockTab" class="tab-content">
            <div class="admin-card-single">
                <div class="card-header-icon">üì¶</div>
                <h2>Tambah Stok Produk</h2>
                <p class="card-description">Tambahkan akun baru ke produk yang sudah ada</p>

                <div id="alertBox" class="alert"></div>

                <form id="addStockForm">
                    <div class="form-group">
                        <label for="productId">
                            <span class="label-icon">üè∑Ô∏è</span>
                            Kode Produk / Product ID
                        </label>
                        <div class="input-with-button">
                            <select id="productId" required>
                                <option value="">Pilih Produk...</option>
                            </select>
                            <button type="button" class="btn-refresh" onclick="loadProducts()" title="Refresh produk">
                                üîÑ
                            </button>
                        </div>
                        <small class="form-hint">Pilih produk yang akan ditambah stok</small>
                    </div>

                    <div class="form-group">
                        <label for="accounts">
                            <span class="label-icon">üìù</span>
                            Akun (Multiple)
                        </label>
                        <textarea 
                            id="accounts" 
                            rows="10"
                            placeholder="Masukkan akun, satu baris per akun dengan format:&#10;email|password|profil|pin|2fa&#10;&#10;Contoh:&#10;user1@gmail.com|pass123|Profil1|1234|ABC123&#10;user2@gmail.com|pass456|Profil2|5678|-&#10;user3@gmail.com|pass789|-|-|-"
                            required
                        ></textarea>
                        <small class="form-hint">
                            <strong>Format:</strong> email|password|profil|pin|2fa<br>
                            <strong>Minimal:</strong> email|password (fields lain bisa dikosongkan dengan tanda - atau dikosongkan)<br>
                            <strong>Pisahkan:</strong> Setiap akun dengan Enter (baris baru)
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="clearForm()">
                            <span class="btn-icon">üóëÔ∏è</span>
                            Clear
                        </button>
                        <button type="submit" class="btn-primary" id="btnSubmit">
                            <span class="btn-icon">‚úÖ</span>
                            Tambah Stok
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products Tab Content -->
        <div id="productsTab" class="tab-content">
            <div class="admin-card-single">
                <div class="card-header-icon">üìã</div>
                <h2>Daftar Produk</h2>
                <p class="card-description">Semua produk dengan jumlah stok</p>

                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" id="searchProduct" placeholder="üîç Cari produk..." onkeyup="filterProductList()">
                </div>

                <div id="productList" class="product-list-admin">
                    <div class="loading-state">Memuat produk...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal for Saldo -->
    <div id="successSaldoModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSuccessSaldoModal()">&times;</span>
            <div class="success-icon" id="successSaldoIcon">‚úÖ</div>
            <h2 id="successSaldoTitle">Saldo Berhasil Diupdate!</h2>
            
            <div class="success-info">
                <p><strong>Nomor User:</strong> <span id="successUserNumber"></span></p>
                <p><strong>Operasi:</strong> <span id="successOperation"></span></p>
                <p><strong>Nominal:</strong> Rp <span id="successNominal"></span></p>
                <p><strong>Saldo Sebelum:</strong> Rp <span id="successBefore"></span></p>
                <p><strong>Saldo Setelah:</strong> Rp <span id="successAfter"></span></p>
            </div>

            <button class="btn-primary" onclick="closeSuccessSaldoModal()">OK</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSuccessModal()">&times;</span>
            <div class="success-icon">‚úÖ</div>
            <h2>Stok Berhasil Ditambahkan!</h2>
            
            <div class="success-info">
                <p><strong>Produk:</strong> <span id="successProduct"></span></p>
                <p><strong>Jumlah akun:</strong> <span id="successCount"></span></p>
                <p><strong>Total stok sekarang:</strong> <span id="successTotal"></span></p>
            </div>

            <button class="btn-primary" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let allProducts = [];

        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success) {
                    window.location.href = '/';
                    return;
                }

                // Check if user is admin
                if (!data.user.isAdmin) {
                    showToast('Akses ditolak. Anda bukan admin.', 'error');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                    return;
                }

                console.log('Admin access granted');
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/products');
                const data = await response.json();

                if (!data.success) {
                    showToast('Gagal memuat produk', 'error');
                    return;
                }

                allProducts = data.products;
                
                // Update dropdown
                const select = document.getElementById('productId');
                select.innerHTML = '<option value="">Pilih Produk...</option>' +
                    allProducts.map(p => 
                        `<option value="${p.id}">${p.name} (ID: ${p.id}) - Stok: ${p.stock}</option>`
                    ).join('');

                // Update product list
                displayProductList(allProducts);
            } catch (error) {
                console.error('Load products failed:', error);
                showToast('Gagal memuat produk', 'error');
            }
        }

        function displayProductList(products) {
            const listContainer = document.getElementById('productList');

            if (products.length === 0) {
                listContainer.innerHTML = '<p class="empty-state">Tidak ada produk</p>';
                return;
            }

            listContainer.innerHTML = products.map(product => `
                <div class="product-item-admin">
                    <div class="product-info-admin">
                        <div class="product-name-admin">${product.name}</div>
                        <div class="product-meta-admin">
                            <span class="product-id">ID: ${product.id}</span>
                            <span class="product-category">${product.category}</span>
                        </div>
                    </div>
                    <div class="product-stats-admin">
                        <div class="stat-item">
                            <span class="stat-label">Stok</span>
                            <span class="stat-value ${product.stock === 0 ? 'stock-empty' : 'stock-available'}">
                                ${product.stock}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Terjual</span>
                            <span class="stat-value">${product.sold || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterProductList() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.id.toLowerCase().includes(searchTerm) ||
                (p.category && p.category.toLowerCase().includes(searchTerm))
            );
            displayProductList(filtered);
        }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        document.getElementById('addStockForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productId = document.getElementById('productId').value.trim();
            const accounts = document.getElementById('accounts').value.trim();

            if (!productId) {
                showAlert('Pilih produk terlebih dahulu');
                return;
            }

            if (!accounts) {
                showAlert('Masukkan akun yang akan ditambahkan');
                return;
            }

            // Validate format
            const lines = accounts.split('\n').filter(l => l.trim().length > 0);
            const invalidLines = lines.filter(line => {
                const parts = line.split('|');
                return parts.length < 2;
            });

            if (invalidLines.length > 0) {
                showAlert(`Format tidak valid pada ${invalidLines.length} baris. Minimal: email|password`, 'error');
                return;
            }

            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="loading"></span>Memproses...';

            try {
                const response = await fetch('/api/admin/addstock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        accounts: accounts
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success modal
                    const product = allProducts.find(p => p.id === productId);
                    document.getElementById('successProduct').textContent = product ? product.name : productId;
                    document.getElementById('successCount').textContent = data.added;
                    document.getElementById('successTotal').textContent = data.newStockCount;
                    document.getElementById('successModal').style.display = 'flex';

                    // Clear form
                    clearForm();

                    // Reload products
                    await loadProducts();
                } else {
                    showAlert(data.message || 'Gagal menambahkan stok', 'error');
                }
            } catch (error) {
                console.error('Add stock error:', error);
                showAlert('Terjadi kesalahan saat menambahkan stok', 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Tambah Stok';
            }
        });

        function clearForm() {
            document.getElementById('productId').value = '';
            document.getElementById('accounts').value = '';
            document.getElementById('alertBox').classList.remove('show');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        function closeSuccessSaldoModal() {
            document.getElementById('successSaldoModal').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        function showSaldoAlert(message, type = 'error') {
            const alertBox = document.getElementById('saldoAlertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        function normalizePhoneNumber(phone) {
            // Remove all non-digit characters (same as index.js: /[^0-9]/g)
            let nomorNya = phone.replace(/[^0-9]/g, '');
            
            // Convert 0 to 62 (Indonesian phone format)
            if (nomorNya.startsWith('0')) {
                nomorNya = '62' + nomorNya.substring(1);
            } else if (!nomorNya.startsWith('62')) {
                // If doesn't start with 62, assume it's Indonesian number
                nomorNya = '62' + nomorNya;
            }
            
            // Ensure we have a valid number
            if (nomorNya.length < 10) {
                throw new Error('Nomor telepon tidak valid');
            }
            
            // Add @s.whatsapp.net (same as index.js addsaldo)
            return nomorNya + '@s.whatsapp.net';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function clearSaldoForm() {
            document.getElementById('userNumber').value = '';
            document.getElementById('nominalSaldo').value = '';
            document.getElementById('saldoAlertBox').classList.remove('show');
        }

        // Handle Add Saldo Form
        document.getElementById('addSaldoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userNumber = document.getElementById('userNumber').value.trim();
            const nominal = parseInt(document.getElementById('nominalSaldo').value);

            if (!userNumber) {
                showSaldoAlert('Masukkan nomor user terlebih dahulu');
                return;
            }

            if (isNaN(nominal) || nominal === 0) {
                showSaldoAlert('Masukkan nominal yang valid (tidak boleh 0)');
                return;
            }

            const btnSubmit = document.getElementById('btnSubmitSaldo');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="loading"></span>Memproses...';

            try {
                // Normalize phone number
                const normalizedNumber = normalizePhoneNumber(userNumber);
                
                // Encode URI component to handle special characters
                const encodedNumber = encodeURIComponent(normalizedNumber);

                const response = await fetch(`/api/admin/users/${encodedNumber}/saldo`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: nominal,
                        reason: 'Add saldo via admin panel'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success modal with before/after saldo
                    const isAdd = nominal > 0;
                    const absNominal = Math.abs(nominal);
                    
                    document.getElementById('successUserNumber').textContent = userNumber;
                    document.getElementById('successOperation').textContent = isAdd ? '‚ûï Tambah Saldo' : '‚ûñ Kurangi Saldo';
                    document.getElementById('successOperation').style.color = isAdd ? '#10b981' : '#ef4444';
                    document.getElementById('successNominal').textContent = formatNumber(absNominal);
                    document.getElementById('successBefore').textContent = formatNumber(data.data.before || 0);
                    document.getElementById('successAfter').textContent = formatNumber(data.data.after || 0);
                    
                    // Update title and icon based on operation
                    document.getElementById('successSaldoTitle').textContent = isAdd ? 'Saldo Berhasil Ditambahkan!' : 'Saldo Berhasil Dikurangi!';
                    document.getElementById('successSaldoIcon').textContent = isAdd ? '‚úÖ' : '‚ö†Ô∏è';
                    
                    document.getElementById('successSaldoModal').style.display = 'flex';

                    // Clear form
                    clearSaldoForm();
                } else {
                    showSaldoAlert(data.error || 'Gagal mengupdate saldo', 'error');
                }
            } catch (error) {
                console.error('Add saldo error:', error);
                showSaldoAlert(error.message || 'Terjadi kesalahan saat menambahkan saldo', 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Update Saldo';
            }
        });

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('successModal');
            const saldoModal = document.getElementById('successSaldoModal');
            if (event.target === modal) {
                closeSuccessModal();
            }
            if (event.target === saldoModal) {
                closeSuccessSaldoModal();
            }
        }

        // Mobile menu toggle
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuIcon = document.getElementById('menuIcon');
            navLinks.classList.toggle('active');
            menuIcon.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const navToggle = document.querySelector('.nav-toggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks.classList.contains('active') && 
                !navbar.contains(event.target)) {
                toggleMenu();
            }
        });

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = {
                'saldo': 'saldoTab',
                'stock': 'stockTab',
                'products': 'productsTab'
            };
            
            document.getElementById(tabContent[tabName]).classList.add('active');
            
            // Add active class to clicked tab
            event.target.closest('.admin-tab').classList.add('active');
            
            // Load products when switching to products tab
            if (tabName === 'products') {
                loadProducts();
            }
        }

        // Initialize
        checkAuth();
        loadProducts();
    </script>
</body>
</html>

